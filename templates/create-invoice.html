<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Create Invoice - TaxLink Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: "#f0f9ff",
                            100: "#e0f2fe",
                            200: "#bae6fd",
                            300: "#7dd3fc",
                            400: "#38bdf8",
                            500: "#0ea5e9",
                            600: "#0284c7",
                            700: "#0369a1",
                            800: "#075985",
                            900: "#0c4a6e",
                        },
                        secondary: {
                            50: "#f5f3ff",
                            100: "#ede9fe",
                            200: "#ddd6fe",
                            300: "#c4b5fd",
                            400: "#a78bfa",
                            500: "#8b5cf6",
                            600: "#7c3aed",
                            700: "#6d28d9",
                            800: "#5b21b6",
                            900: "#4c1d95",
                        },
                        accent: {
                            50: "#f0fdfa",
                            100: "#ccfbf1",
                            200: "#99f6e4",
                            300: "#5eead4",
                            400: "#2dd4bf",
                            500: "#14b8a6",
                            600: "#0d9488",
                            700: "#0f766e",
                            800: "#115e59",
                            900: "#134e4a",
                        },
                    },
                },
            },
        };
    </script>
    <style>
        /* Custom CSS for animations and elements not covered by Tailwind */
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #38bdf8;
        }

        .step-active {
            background-color: #0ea5e9;
            color: white;
        }

        .step-completed {
            background-color: #10b981;
            color: white;
        }

        .step-inactive {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        .step-line {
            height: 2px;
            background-color: #e5e7eb;
            flex-grow: 1;
            margin: 0 8px;
        }

        .step-line-active {
            background-color: #0ea5e9;
        }

        .step-line-completed {
            background-color: #10b981;
        }

        .sidebar-item:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
        }

        .step-active {
            background-color: #0ea5e9;
            color: white;
        }

        .step-completed {
            background-color: #10b981;
            color: white;
        }

        .step-inactive {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        .step-line {
            height: 2px;
            background-color: #e5e7eb;
            flex-grow: 1;
            margin: 0 8px;
        }

        .step-line-active {
            background-color: #0ea5e9;
        }

        .step-line-completed {
            background-color: #10b981;
        }

        /* Enhanced sidebar styles */
        .sidebar {
            background: linear-gradient(to bottom, #075985, #0c4a6e);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-logo {
            transition: all 0.3s ease;
        }

        .sidebar-logo:hover {
            transform: scale(1.05);
        }

        /* Form input styles */
        .form-input:focus {
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        /* Modal styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        /* Notification component */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 50;
            transition: all 0.3s ease;
            transform: translateY(-100px);
            opacity: 0;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification-success {
            background-color: #10b981;
            color: white;
        }

        .notification-error {
            background-color: #ef4444;
            color: white;
        }

        .notification-info {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="hidden md:flex md:flex-shrink-0">
            <div class="flex flex-col sidebar" style="width: 200px; min-width: 200px; max-width: 200px">
                <!-- Logo and User Info Section -->
                <div class="flex flex-col items-center justify-center pt-5 pb-2">
                    <!-- Logo -->
                    <div class="sidebar-logo w-32 mb-4">
                        <img src="https://clkbskiomtjlqkbbheaj.supabase.co/storage/v1/object/public/taxlinkprologo/ChatGPT_Image_Aug_11__2025__02_40_38_AM-removebg-preview.png"
                            alt="TaxLink Pro Logo" class="w-full h-auto" />
                    </div>

                    <!-- Divider -->
                    <div class="w-full px-6">
                        <div class="border-b border-blue-400 opacity-50"></div>
                    </div>

                    <!-- User Info -->
                    <div class="flex items-center justify-center mt-4 mb-2 px-4">
                        <div class="flex items-center">
                            <span class="text-white font-medium">{{ session['name'] }}</span>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <div class="flex flex-col flex-grow pt-4 pb-4 overflow-y-auto">
                    <nav class="flex-1 space-y-2 px-2">
                        <a href="/dashboard.html" id="dashboard-tab"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-md text-white">
                            <i class="fas fa-tachometer-alt mr-3"></i>
                            Dashboard
                        </a>
                        <a href="/create-invoice.html" id="create-invoice-tab"
                            class="sidebar-item active flex items-center px-4 py-3 text-sm font-medium rounded-md text-white">
                            <i class="fas fa-file-invoice mr-3"></i>
                            Create Invoice
                        </a>
                        <a href="/draft-invoices.html" id="draft-invoices-tab"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-md text-white">
                            <i class="fas fa-file-alt mr-3"></i>
                            Draft Invoices
                        </a>
                        <a href="/reports.html" id="reports-tab"
                            class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-md text-white">
                            <i class="fas fa-chart-bar mr-3"></i>
                            Reports & Analytics
                        </a>

                    </nav>

                    <!-- Environment Badge - Increased Size -->
                    <div class="px-4 py-4 text-center">
                        <span
                            class="env-badge bg-primary-400 text-white text-sm font-bold px-4 py-2 rounded-full shadow-md inline-flex items-center">
                            <i class="fas fa-cube mr-2 text-base"></i>{{ session['env'] }}
                        </span>
                    </div>

                    <!-- Logout Button - Centered -->
                    <div class="px-2 mt-auto text-center">
                        <a href="/logout"
                            class="sidebar-item flex items-center justify-center px-4 py-3 text-sm font-medium rounded-md text-white">
                            <i class="fas fa-sign-out-alt mr-3"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Mobile Header -->
            <div class="md:hidden bg-primary-700 text-white p-4 flex items-center justify-between">
                <div class="flex items-center">
                    <img src="https://clkbskiomtjlqkbbheaj.supabase.co/storage/v1/object/public/taxlinkprologo/ChatGPT_Image_Aug_11__2025__02_40_38_AM-removebg-preview.png"
                        alt="TaxLink Pro Logo" class="h-8 mr-2" />
                    <span class="font-semibold text-lg">TaxLink Pro</span>
                </div>
                <button id="mobile-menu-button" class="focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Mobile Menu (hidden by default) -->
            <div id="mobile-menu" class="fixed inset-0 z-40 md:hidden hidden">
                <div class="absolute inset-0 bg-black opacity-50"></div>
                <div
                    class="absolute inset-y-0 left-0 max-w-xs w-full bg-primary-800 text-white shadow-xl flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b border-primary-700">
                        <img src="https://clkbskiomtjlqkbbheaj.supabase.co/storage/v1/object/public/taxlinkprologo/ChatGPT_Image_Aug_11__2025__02_40_38_AM-removebg-preview.png"
                            alt="TaxLink Pro Logo" class="h-8" />
                        <button id="close-mobile-menu" class="text-white focus:outline-none">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-4 border-b border-primary-700">
                        <div class="flex items-center">
                            <div
                                class="w-8 h-8 bg-blue-300 rounded-full flex items-center justify-center text-primary-800 font-bold mr-2">
                                {{ session['name'][0] }}
                            </div>
                            <span class="text-white font-medium">{{ session['name'] }}</span>
                        </div>
                    </div>
                    <nav class="flex-1 p-4">
                        <a href="/dashboard.html" class="block py-2 px-4 text-white hover:bg-primary-700 rounded-md">
                            <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
                        </a>
                        <a href="/create-invoice.html" class="block py-2 px-4 text-white bg-primary-700 rounded-md">
                            <i class="fas fa-file-invoice mr-3"></i> Create Invoice
                        </a>
                    </nav>
                    <div class="p-4 border-t border-primary-700">
                        <span
                            class="bg-primary-400 text-white text-sm font-bold px-4 py-2 rounded-full shadow-md inline-flex items-center">
                            <i class="fas fa-cube mr-2 text-base"></i>{{ session['env'] }}
                        </span>
                    </div>
                    <div class="p-4 border-t border-primary-700">
                        <a href="/logout" class="block py-2 px-4 text-white hover:bg-primary-700 rounded-md">
                            <i class="fas fa-sign-out-alt mr-3"></i> Logout
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main content area -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8 bg-gray-50">
                <div id="create-invoice-content">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">
                            Create New Invoice
                        </h1>
                        <a href="/dashboard.html"
                            class="mt-3 md:mt-0 text-primary-600 hover:text-primary-700 font-medium flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                        </a>
                    </div>

                    <!-- Progress Steps -->
                    <!-- Progress Steps -->
                    <div class="mb-8">
                        <div class="flex items-center">
                            <!-- Step 1 -->
                            <div class="flex flex-col items-center">
                                <div id="step-1-indicator"
                                    class="step-active w-8 h-8 rounded-full flex items-center justify-center">
                                    1
                                </div>
                                <div class="mt-2 text-xs text-center w-20">Seller Info</div>
                            </div>

                            <!-- Line 1-2 -->
                            <div id="step-1-2-line" class="step-line"></div>

                            <!-- Step 2 -->
                            <div class="flex flex-col items-center">
                                <div id="step-2-indicator"
                                    class="step-inactive w-8 h-8 rounded-full flex items-center justify-center">
                                    2
                                </div>
                                <div class="mt-2 text-xs text-center w-20">Invoice Details</div>
                            </div>

                            <!-- Line 2-3 -->
                            <div id="step-2-3-line" class="step-line"></div>

                            <!-- Step 3 -->
                            <div class="flex flex-col items-center">
                                <div id="step-3-indicator"
                                    class="step-inactive w-8 h-8 rounded-full flex items-center justify-center">
                                    3
                                </div>
                                <div class="mt-2 text-xs text-center w-20">Buyer Info</div>
                            </div>

                            <!-- Line 3-4 -->
                            <div id="step-3-4-line" class="step-line"></div>

                            <!-- Step 4 -->
                            <div class="flex flex-col items-center">
                                <div id="step-4-indicator"
                                    class="step-inactive w-8 h-8 rounded-full flex items-center justify-center">
                                    4
                                </div>
                                <div class="mt-2 text-xs text-center w-20">Products</div>
                            </div>

                            <!-- Line 4-5 -->
                            <div id="step-4-5-line" class="step-line"></div>

                            <!-- Step 5 -->
                            <div class="flex flex-col items-center">
                                <div id="step-5-indicator"
                                    class="step-inactive w-8 h-8 rounded-full flex items-center justify-center">
                                    5
                                </div>
                                <div class="mt-2 text-xs text-center w-20">Review</div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Seller Information -->
                    <div id="step-1" class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-lg font-semibold mb-4">Seller Information</h2>

                        <!-- Select Existing Business Profile or Create New -->
                        <div class="mb-6">
                            <label class="block text-gray-700 font-medium mb-2">Select Business Profile</label>
                            <div class="flex items-center">
                                <select id="business-profile-select"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md mr-2 focus:outline-none focus:border-primary-500">
                                    <option value="">-- Select Business Profile --</option>
                                </select>
                                <button id="add-business-profile-btn"
                                    class="bg-secondary-600 hover:bg-secondary-700 text-white px-4 py-2 rounded-md">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Business Form Fields -->
                        <div id="seller-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="seller-business-name"
                                        class="block text-gray-700 font-medium mb-2">Business Name*</label>
                                    <input type="text" id="seller-business-name"
                                        class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                        placeholder="Enter business name" />
                                </div>
                                <div>
                                    <label for="seller-ntn-cnic"
                                        class="block text-gray-700 font-medium mb-2">NTN/CNIC*</label>
                                    <input type="text" id="seller-ntn-cnic"
                                        class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                        placeholder="Enter NTN or CNIC" />
                                </div>
                                <div>
                                    <label for="seller-strn" class="block text-gray-700 font-medium mb-2">STRN</label>
                                    <input type="text" id="seller-strn"
                                        class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                        placeholder="Enter STRN (if applicable)" />
                                </div>
                                <div>
                                    <label for="seller-province"
                                        class="block text-gray-700 font-medium mb-2">Province*</label>
                                    <select id="seller-province"
                                        class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500">
                                        <option value="">-- Select Province --</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="seller-address"
                                        class="block text-gray-700 font-medium mb-2">Address*</label>
                                    <textarea id="seller-address" rows="3"
                                        class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                        placeholder="Enter business address"></textarea>
                                </div>
                            </div>

                            <!-- Removed legacy seller save/default checkboxes -->
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="mt-8 flex justify-end">
                            <button id="step1-next"
                                class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                                Next <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Invoice Details (Initially Hidden) -->
                <div id="step-2" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-lg font-semibold mb-4">Invoice Details</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="invoice-type" class="block text-gray-700 font-medium mb-2">Invoice Type*</label>
                            <input type="text" id="invoice-type" value="Sale Invoice"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-700 cursor-not-allowed"
                                readonly disabled>
                            <!-- Hidden field to ensure the value is still submitted with the form -->
                            <input type="hidden" id="invoice-type-hidden" value="Sale Invoice">
                        </div>
                        <div>
                            <label for="invoice-date" class="block text-gray-700 font-medium mb-2">Invoice Date*</label>
                            <input type="date" id="invoice-date"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500" />
                        </div>
                        <div>
                            <label for="invoice-ref-no" class="block text-gray-700 font-medium mb-2">Invoice Reference
                                No.</label>
                            <input type="text" id="invoice-ref-no"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                placeholder="Enter reference number" />
                        </div>
                        <div>
                            <label for="po-number" class="block text-gray-700 font-medium mb-2">PO#</label>
                            <input type="text" id="po-number"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                placeholder="Enter purchase order number" />
                        </div>
                        <div id="dc-number-container" class="hidden">
                            <label for="dc-number" class="block text-gray-700 font-medium mb-2">DC #</label>
                            <input type="text" id="dc-number"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                placeholder="Enter delivery challan number" />
                        </div>
                        <div id="delivery-challan-container" class="hidden">
                            <label for="delivery-challan" class="block text-gray-700 font-medium mb-2">Delivery Challan
                                #</label>
                            <input type="text" id="delivery-challan"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                placeholder="Enter delivery challan number" />
                        </div>

                        <!-- Sandbox Scenario ID (only shown in sandbox) -->
                        <div id="scenario-id-container" class="hidden">
                            <label for="scenario-id" class="block text-gray-700 font-medium mb-2">Scenario ID
                                (Sandbox)</label>
                            <select id="scenario-id"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500">
                                <option value="">-- Select Scenario ID --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="mt-8 flex justify-between">
                        <button id="step2-prev"
                            class="border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button id="step2-next"
                            class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Buyer Information (Initially Hidden) -->
                <div id="step-3" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-lg font-semibold mb-4">Buyer Information</h2>

                    <!-- Select Existing Buyer or Create New -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-medium mb-2">Select Buyer</label>
                        <div class="flex items-center">
                            <select id="buyer-select"
                                class="form-input w-full px-4 py-2 border border-gray-300 rounded-md mr-2 focus:outline-none focus:border-primary-500">
                                <option value="">-- Select Buyer --</option>
                            </select>
                            <button id="add-buyer-btn"
                                class="bg-secondary-600 hover:bg-secondary-700 text-white px-4 py-2 rounded-md">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Buyer Form Fields -->
                    <div id="buyer-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="buyer-business-name" class="block text-gray-700 font-medium mb-2">Business
                                    Name*</label>
                                <input type="text" id="buyer-business-name"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                    placeholder="Enter business name" />
                            </div>
                            <div>
                                <label for="buyer-ntn-cnic"
                                    class="block text-gray-700 font-medium mb-2">NTN/CNIC*</label>
                                <input type="text" id="buyer-ntn-cnic"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                    placeholder="Enter NTN or CNIC" />
                            </div>
                            <div>
                                <label for="buyer-strn" class="block text-gray-700 font-medium mb-2">STRN</label>
                                <input type="text" id="buyer-strn"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                    placeholder="Enter STRN (if applicable)" />
                            </div>
                            <div>
                                <label for="buyer-province"
                                    class="block text-gray-700 font-medium mb-2">Province*</label>
                                <select id="buyer-province"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500">
                                    <option value="">-- Select Province --</option>
                                </select>
                            </div>
                            <div>
                                <label for="buyer-registration-type"
                                    class="block text-gray-700 font-medium mb-2">Registration Type*</label>
                                <select id="buyer-registration-type"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500">
                                    <option value="">-- Select Registration Type --</option>
                                </select>
                            </div>
                            <div>
                                <label for="buyer-code" class="block text-gray-700 font-medium mb-2">Buyer Code</label>
                                <input type="text" id="buyer-code"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                    placeholder="Enter buyer code (if any)" />
                            </div>
                            <div class="md:col-span-2">
                                <label for="buyer-address" class="block text-gray-700 font-medium mb-2">Address*</label>
                                <textarea id="buyer-address" rows="3"
                                    class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500"
                                    placeholder="Enter business address"></textarea>
                            </div>
                        </div>

                        <!-- Removed buyer save/default checkboxes -->
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="mt-8 flex justify-between">
                        <button id="step3-prev"
                            class="border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button id="step3-next"
                            class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Products (Initially Hidden) -->
                <div id="step-4" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-lg font-semibold mb-4">Product Items</h2>

                    <!-- Product Item Form -->
                    <div class="bg-gray-50 p-4 rounded-md mb-6">
                        <h3 class="font-medium text-gray-700 mb-3">Add Product Item</h3>

                        <!-- Product Dropdown Section (will be shown conditionally) -->
                        <div id="product-dropdown-container" class="mb-4">
                            <label class="block text-gray-700 text-sm mb-1 font-medium">Select Product*</label>
                            <div class="flex">
                                <!-- Selector (flex-1 so it fills remaining width) -->
                                <div id="product-selector" class="relative flex-1">
                                    <button type="button" id="product-select-btn"
                                        class="w-full flex justify-between items-center px-3 py-2 border border-gray-300 rounded-md bg-white text-left text-sm hover:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                        <span id="product-selected-label" class="truncate text-gray-700">-- Select
                                            Product --</span>
                                        <span class="ml-2 text-gray-400"><i class="fas fa-chevron-down"></i></span>
                                    </button>

                                    <div id="product-menu"
                                        class="hidden absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-xl">
                                        <div class="p-2 border-b border-gray-100">
                                            <input id="product-filter" type="text" placeholder="Search..."
                                                class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-primary-500">
                                        </div>
                                        <ul id="product-menu-list" class="max-h-60 overflow-y-auto text-sm"></ul>
                                        <div
                                            class="flex justify-end items-center p-2 border-t border-gray-100 bg-gray-50">
                                            <button id="close-product-menu"
                                                class="text-gray-500 hover:text-gray-700 text-xs px-2 py-1">
                                                Close
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Plus button (mirrors buyer add button style) -->
                                <button id="reset-product-btn"
                                    class="ml-2 bg-secondary-600 hover:bg-secondary-700 text-white px-4 py-2 rounded-md"
                                    title="Clear selection & reset product fields">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>

                            <!-- Hidden custom product input (reuse existing logic) -->
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="product-description"
                                    class="block text-gray-700 text-sm mb-1">Description*</label>
                                <input type="text" id="product-description"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="Enter product description">
                            </div>
                            <div id="product-code-wrapper" class="hidden">
                                <label for="product-code" class="block text-gray-700 text-sm mb-1">Product Code</label>
                                <input type="text" id="product-code"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="Enter product code">
                            </div>
                            <div>
                                <label for="product-hs-code" class="block text-gray-700 text-sm mb-1">HS Code*</label>
                                <input type="text" id="product-hs-code"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="HS code">
                            </div>
                            <div>
                                <label for="product-quantity" class="block text-gray-700 text-sm mb-1">Quantity*</label>
                                <input type="number" id="product-quantity"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="Quantity" min="0" step="1">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                            <div> <label for="product-uom" class="block text-gray-700 text-sm mb-1">UoM*</label> <select
                                    id="product-uom"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm">
                                    <option value="">-- Select Unit --</option>
                                </select> </div>
                            <div> <label for="product-rate" class="block text-gray-700 text-sm mb-1">Rate (per
                                    unit)</label> <input type="number" id="product-rate"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="Enter per-unit rate" min="0" step="0.01"> </div>
                            <div> <label for="product-value-excl" class="block text-gray-700 text-sm mb-1">Value Excl.
                                    ST*</label> <input type="number" id="product-value-excl"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-sm cursor-not-allowed"
                                    placeholder="Auto-calculated" min="0" step="0.01" readonly> </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                            <div>
                                <label for="product-tax-rate" class="block text-gray-700 text-sm mb-1">Tax Rate*</label>
                                <select id="product-tax-rate"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm">
                                    <option value="">-- Select Tax Rate --</option>
                                </select>
                            </div>
                            <div>
                                <label for="product-tax-amount" class="block text-gray-700 text-sm mb-1">Tax
                                    Amount*</label>
                                <input type="number" id="product-tax-amount"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-sm cursor-not-allowed"
                                    placeholder="Auto-calculated" min="0" step="0.01" readonly>
                            </div>
                            <div>
                                <label for="product-sale-type" class="block text-gray-700 text-sm mb-1">Sale
                                    Type*</label>
                                <input type="text" id="product-sale-type"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="Sale type" value="Goods at Reduced Rate">
                            </div>
                        </div>

                        <!-- Add the additional FBR fields -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                            <div>
                                <label for="product-sro-schedule-no" class="block text-gray-700 text-sm mb-1">SRO
                                    Schedule No</label>
                                <input type="text" id="product-sro-schedule-no"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm">
                            </div>
                            <div>
                                <label for="product-sro-item-serial-no" class="block text-gray-700 text-sm mb-1">SRO
                                    Item Serial No</label>
                                <input type="text" id="product-sro-item-serial-no"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm">
                            </div>
                            <div>
                                <label for="product-further-tax" class="block text-gray-700 text-sm mb-1">Further
                                    Tax</label>
                                <div class="relative">
                                    <input type="number" id="product-further-tax"
                                        class="form-input w-full pr-10 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                        placeholder="0" value="0" min="0" step="0.01"
                                        title="Enter percentage only. The value will be treated as % of the amount excluding sales tax.">
                                    <span class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-500 text-sm">%</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                            <div>
                                <label for="product-extra-tax" class="block text-gray-700 text-sm mb-1">Extra
                                    Tax</label>
                                <input type="text" id="product-extra-tax"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="" value="">
                            </div>
                            <div>
                                <label for="product-st-withheld" class="block text-gray-700 text-sm mb-1">Sales Tax
                                    Withheld</label>
                                <input type="number" id="product-st-withheld"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="0" value="0" min="0" step="0.01">
                            </div>
                            <div>
                                <label for="product-fed-payable" class="block text-gray-700 text-sm mb-1">FED
                                    Payable</label>
                                <input type="number" id="product-fed-payable"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="0" value="0" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                            <div>
                                <label for="product-discount" class="block text-gray-700 text-sm mb-1">Discount</label>
                                <input type="number" id="product-discount"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="0" value="0" min="0" step="0.01">
                            </div>
                            <div>
                                <label for="product-fixed-value" class="block text-gray-700 text-sm mb-1">Fixed Notified
                                    Value</label>
                                <input type="number" id="product-fixed-value"
                                    class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary-500 text-sm"
                                    placeholder="0" value="0" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="save-products-for-future"
                                    class="form-checkbox h-5 w-5 text-primary-600">
                                <span class="ml-2 text-gray-700 text-sm">
                                    Save new product for future use
                                </span>
                            </label>
                        </div>

                        <div class="flex justify-end mt-4">
                            <button id="add-product-item-btn"
                                class="bg-secondary-600 hover:bg-secondary-700 text-white px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-plus mr-1"></i> Add Item
                            </button>
                        </div>
                    </div>

                    <!----------------------------------------------------------------------------------------------------------------------------->

                    <!-- Product Items Table -->
                    <div class="overflow-x-auto mt-6">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Description
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        HS Code
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Qty
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        UoM
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Rate
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Value Excl.
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Tax Amount
                                    </th>
                                    <th scope="col" id="product-further-tax-header"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden">
                                        Further Tax
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Total
                                    </th>
                                    <th scope="col"
                                        class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="product-items-table" class="bg-white divide-y divide-gray-200">
                                <!-- No products message -->
                                <tr id="no-products-row">
                                    <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                                        No products added yet. Add products using the form
                                        above.
                                    </td>
                                </tr>
                            </tbody>
                            <!-- Totals row -->
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="6" class="px-6 py-3 text-right font-medium">
                                        Totals:
                                    </td>
                                    <td class="px-3 py-3 font-medium" id="total-value-excl">
                                        0.00
                                    </td>
                                    <td class="px-3 py-3 font-medium" id="total-tax-amount">
                                        0.00
                                    </td>
                                    <td class="px-3 py-3 font-medium" id="grand-total">
                                        0.00
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="mt-8 flex justify-between">
                        <button id="step4-prev"
                            class="border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <button id="step4-next"
                            class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                            Next <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 5: Review (Initially Hidden) -->
                <div id="step-5" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-lg font-semibold mb-4">Review Invoice</h2>

                    <!-- Review Summary -->
                    <div class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Seller Information -->
                            <div class="bg-gray-50 p-4 rounded-md">
                                <h3 class="font-medium text-gray-800 mb-2">
                                    Seller Information
                                </h3>
                                <div class="text-sm">
                                    <p>
                                        <span class="font-semibold">Business:</span>
                                        <span id="review-seller-name"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">NTN/CNIC:</span>
                                        <span id="review-seller-ntn"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">STRN:</span>
                                        <span id="review-seller-strn"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Address:</span>
                                        <span id="review-seller-address"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Province:</span>
                                        <span id="review-seller-province"></span>
                                    </p>
                                </div>
                            </div>

                            <!-- Buyer Information -->
                            <div class="bg-gray-50 p-4 rounded-md">
                                <h3 class="font-medium text-gray-800 mb-2">
                                    Buyer Information
                                </h3>
                                <div class="text-sm">
                                    <p>
                                        <span class="font-semibold">Business:</span>
                                        <span id="review-buyer-name"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">NTN/CNIC:</span>
                                        <span id="review-buyer-ntn"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">STRN:</span>
                                        <span id="review-buyer-strn"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Address:</span>
                                        <span id="review-buyer-address"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Province:</span>
                                        <span id="review-buyer-province"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Registration Type:</span>
                                        <span id="review-buyer-registration"></span>
                                    </p>
                                </div>
                            </div>

                            <!-- Invoice Details -->
                            <div class="bg-gray-50 p-4 rounded-md">
                                <h3 class="font-medium text-gray-800 mb-2">
                                    Invoice Details
                                </h3>
                                <div class="text-sm">
                                    <p>
                                        <span class="font-semibold">Invoice Type:</span>
                                        <span id="review-invoice-type"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Invoice Date:</span>
                                        <span id="review-invoice-date"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Invoice Ref No:</span>
                                        <span id="review-invoice-ref"></span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">PO#:</span>
                                        <span id="review-po-number"></span>
                                    </p>
                                    <p id="review-delivery-challan-container" class="hidden">
                                        <span class="font-semibold">Delivery Challan #:</span>
                                        <span id="review-delivery-challan"></span>
                                    </p>
                                    <p id="review-scenario-container" class="hidden">
                                        <span class="font-semibold">Scenario ID:</span>
                                        <span id="review-scenario-id"></span>
                                    </p>
                                </div>
                            </div>

                            <!-- Totals -->
                            <div class="bg-gray-50 p-4 rounded-md">
                                <h3 class="font-medium text-gray-800 mb-2">
                                    Invoice Totals
                                </h3>
                                <div class="text-sm">
                                    <p>
                                        <span class="font-semibold">Items Count:</span>
                                        <span id="review-items-count">0</span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Value Excl. Tax:</span> PKR
                                        <span id="review-value-excl">0.00</span>
                                    </p>
                                    <p>
                                        <span class="font-semibold">Sales Tax:</span> PKR
                                        <span id="review-tax-amount">0.00</span>
                                    </p>
                                    <p id="review-further-tax-row" class="hidden">
                                        <span class="font-semibold">Further Tax:</span> PKR
                                        <span id="review-further-tax">0.00</span>
                                    </p>
                                    <p class="text-base font-bold mt-2 text-primary-700">
                                        <span>Total Amount:</span> PKR
                                        <span id="review-grand-total">0.00</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Items Review -->
                    <div class="mt-6">
                        <h3 class="font-medium text-gray-800 mb-3">Product Items</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Description
                                        </th>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            HS Code
                                        </th>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Qty
                                        </th>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            UoM
                                        </th>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Rate
                                        </th>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Value Excl.
                                        </th>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Tax Amount
                                        </th>
                                        <th scope="col" id="review-further-tax-header"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden">
                                            Further Tax
                                        </th>
                                        <th scope="col"
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Total
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="review-items-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Product items will be populated here -->
                                    <tr id="review-no-products-row">
                                        <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                                            No products added yet.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <!-- Navigation Buttons for Step 5 -->
                    <!-- Navigation Buttons for Step 5 -->
                    <div class="mt-8 flex justify-between">
                        <button id="step5-prev"
                            class="border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Back
                        </button>
                        <div class="flex space-x-3">
                            <button id="view-json-btn"
                                class="bg-secondary-600 hover:bg-secondary-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                                <i class="fas fa-code mr-2"></i> View JSON
                            </button>
                            <button id="submit-invoice-btn"
                                class="bg-accent-600 hover:bg-accent-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                                <i class="fas fa-paper-plane mr-2"></i> Submit to FBR
                            </button>
                            <button id="generate-invoice-btn"
                                class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                                <i class="fas fa-file-pdf mr-2"></i> Generate Invoice
                            </button>
                            <button id="save-draft-btn"
                                class="bg-secondary-600 hover:bg-secondary-700 text-white font-medium py-2 px-6 rounded-md transition duration-150 ease-in-out flex items-center">
                                <i class="fas fa-save mr-2"></i> Save Draft
                            </button>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    </main>
    </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification">
        <div class="flex items-center">
            <i id="notification-icon" class="mr-3"></i>
            <div>
                <h4 id="notification-title" class="font-medium"></h4>
                <p id="notification-message" class="text-sm opacity-90"></p>
            </div>
        </div>
    </div>

    <!-- Business Profile Management Modal -->
    <div id="business-profile-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Manage Business Profiles</h3>
                    <button id="close-business-profile-modal" class="text-gray-400 hover:text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="mb-4 flex items-center space-x-2">
                    <input type="text" id="business-profile-search" placeholder="Search profiles..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
                    <button id="new-business-profile-btn" class="px-3 py-2 bg-secondary-600 hover:bg-secondary-700 text-white rounded-md text-sm"><i class="fas fa-plus mr-1"></i>New</button>
                </div>
                <div id="business-profile-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto border border-gray-200 rounded-md p-2 bg-gray-50"></div>
                <div id="business-profile-form" class="hidden border-t pt-4">
                    <h4 class="font-medium text-gray-800 mb-2" id="business-profile-form-title">Create Profile</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Business Name*</label>
                            <input id="bp-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">NTN/CNIC*</label>
                            <input id="bp-ntn" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">STRN</label>
                            <input id="bp-strn" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Province*</label>
                            <select id="bp-province" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm">
                                <option value="">-- Select Province --</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Address*</label>
                            <textarea id="bp-address" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"></textarea>
                        </div>
                        <div class="flex items-center space-x-2 md:col-span-2">
                            <input id="bp-default" type="checkbox" class="h-4 w-4 text-primary-600" />
                            <label for="bp-default" class="text-sm text-gray-700">Set as default</label>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button id="cancel-bp-form" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 text-sm">Cancel</button>
                        <button id="save-bp-form" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md text-sm font-medium"><i class="fas fa-save mr-1"></i>Save Profile</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buyer Management Modal -->
    <div id="buyer-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Manage Buyers</h3>
                    <button id="close-buyer-modal" class="text-gray-400 hover:text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="mb-4 flex items-center space-x-2">
                    <input type="text" id="buyer-search" placeholder="Search buyers..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
                    <button id="new-buyer-btn" class="px-3 py-2 bg-secondary-600 hover:bg-secondary-700 text-white rounded-md text-sm"><i class="fas fa-plus mr-1"></i>New</button>
                </div>
                <div id="buyer-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto border border-gray-200 rounded-md p-2 bg-gray-50"></div>
                <div id="buyer-form-modal" class="hidden border-t pt-4">
                    <h4 class="font-medium text-gray-800 mb-2" id="buyer-form-title">Create Buyer</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Business Name*</label><input id="by-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">NTN/CNIC*</label><input id="by-ntn" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">STRN</label><input id="by-strn" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Province*</label><select id="by-province" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select Province --</option></select></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Registration Type*</label><select id="by-reg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select Type --</option></select></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Buyer Code</label><input id="by-code" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
                        <div class="md:col-span-2"><label class="block text-xs font-semibold text-gray-600 mb-1">Address*</label><textarea id="by-address" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"></textarea></div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button id="cancel-buyer-form" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 text-sm">Cancel</button>
                        <button id="save-buyer-form" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md text-sm font-medium"><i class="fas fa-save mr-1"></i>Save Buyer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Creation Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Create Product</h3>
                    <button id="close-product-modal" class="text-gray-400 hover:text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="mb-4 flex items-center space-x-2">
                    <input type="text" id="product-search-modal" placeholder="Search existing..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
                    <button id="refresh-products-btn" class="px-3 py-2 bg-secondary-600 hover:bg-secondary-700 text-white rounded-md text-sm"><i class="fas fa-rotate mr-1"></i>Refresh</button>
                </div>
                <div id="product-list-modal" class="space-y-2 mb-6 max-h-56 overflow-y-auto border border-gray-200 rounded-md p-2 bg-gray-50"></div>
                <div id="product-form-modal" class="border-t pt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Description*</label><input id="pm-desc" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
                        <div id="pm-code-wrapper" class="hidden"><label class="block text-xs font-semibold text-gray-600 mb-1">Product Code</label><input id="pm-code" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">HS Code</label><input id="pm-hs" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Rate (Unit)</label><input id="pm-rate" type="number" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">UoM*</label><select id="pm-uom" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select UoM --</option></select></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Default Tax Rate*</label><select id="pm-tax" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select Tax --</option></select></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">Sale Type</label><input id="pm-sale-type" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" value="Goods at Reduced Rate" /></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">SRO Schedule No</label><input id="pm-sro-schedule" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
                        <div><label class="block text-xs font-semibold text-gray-600 mb-1">SRO Item Serial No</label><input id="pm-sro-item" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button id="cancel-product-form" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 text-sm">Cancel</button>
                        <button id="save-product-form" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md text-sm font-medium"><i class="fas fa-save mr-1"></i>Save Product</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Get environment from session variable, if available, otherwise default to URL param or 'production'
        const ENV = "{{ session.get('env', '') }}" || new URLSearchParams(window.location.search).get('env') || 'production';
        console.log('Current environment:', ENV);
        
        function apiUrl(endpoint) {
            // Always use URL parameter first, then fall back to ENV constant
            const env = getUrlParameter('env') || ENV;
            console.log(`API URL: ${endpoint}?env=${env}`);
            return `${endpoint}?env=${env}`;
        }

        // State to store form data
        const state = {
            currentStep: 1,
            formOptions: null,
            sellerData: {},
            buyerData: {},
            invoiceData: {},
            productItems: [],
            draft_id: null, // Store draft ID if loaded from a draft
        };

        const TAX_ID_ERROR_MESSAGE = "must be 7 characters (NTN) or 13 digits (CNIC).";

        function normalizeTaxIdValue(value) {
            const raw = (value || "").toString().trim().toUpperCase();
            const digitsOnly = raw.replace(/\D/g, "");
            if (digitsOnly.length === 13) {
                return digitsOnly;
            }
            return raw.replace(/[^A-Z0-9]/g, "");
        }

        function getValidTaxId(value) {
            const normalized = normalizeTaxIdValue(value);
            if (/^\d{13}$/.test(normalized)) {
                return normalized;
            }
            if (/^[A-Z0-9]{7}$/.test(normalized)) {
                return normalized;
            }
            return null;
        }

        function enforceTaxIdOnInput(inputElement, label) {
            if (!inputElement) {
                return null;
            }
            const validValue = getValidTaxId(inputElement.value);
            if (!validValue) {
                showNotification(
                    "error",
                    "Validation Error",
                    `${label} ${TAX_ID_ERROR_MESSAGE}`
                );
                inputElement.focus();
                return null;
            }
            inputElement.value = validValue;
            return validValue;
        }

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        const scenarioToSaleType = {
            'SN001': 'Goods at standard rate (default)',
            'SN002': 'Goods at standard rate (default)',
            'SN003': 'Steel melting and re-rolling',
            'SN004': 'Ship breaking',
            'SN005': 'Goods at Reduced Rate',
            'SN006': 'Exempt goods',
            'SN007': 'Goods at zero-rate',
            'SN008': '3rd Schedule Goods',
            'SN009': 'Cotton Ginners',
            'SN010': 'Telecommunication services',
            'SN011': 'Toll Manufacturing',
            'SN012': 'Petroleum Products',
            'SN013': 'Electricity Supply to Retailers',
            'SN014': 'Gas to CNG stations',
            'SN015': 'Mobile Phones',
            'SN016': 'Processing/ Conversion of Goods',
            'SN017': 'Goods (FED in ST Mode)',
            'SN018': 'Services (FED in ST Mode)',
            'SN019': 'Services',
            'SN020': 'Electric Vehicle',
            'SN021': 'Cement /Concrete Block',
            'SN022': 'Potassium Chlorate',
            'SN023': 'CNG Sales',
            'SN024': 'Goods as per SRO.297(|)/2023',
            'SN025': 'Non-Adjustable Supplies',
            'SN026': 'Goods at standard rate',
            'SN027': '3rd Schedule Goods',
            'SN028': 'Goods at Reduced Rate'
        };

        let currentUsername = null;
        const SPECIAL_USERNAMES = ['H075895', 'F667833', 'infinityeng'];
        let usernameFetchPromise = null;

        function isH075895User(username = currentUsername) {
            if (!username) {
                return false;
            }
            return SPECIAL_USERNAMES.includes(username.trim());
        }

        async function ensureCurrentUsername() {
            if (currentUsername) {
                return currentUsername;
            }
            if (usernameFetchPromise) {
                return usernameFetchPromise;
            }
            usernameFetchPromise = fetch(apiUrl("/api/user-product-settings"))
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch user settings");
                    }
                    return response.json();
                })
                .then(settings => {
                    setCurrentUsernameValue(settings.username);
                    return currentUsername;
                })
                .catch(error => {
                    console.error("Error fetching username:", error);
                    usernameFetchPromise = null;
                    throw error;
                });
            return usernameFetchPromise;
        }

        function fetchUsername() {
            return ensureCurrentUsername();
        }

        function applyH075895UI(username = currentUsername) {
            if (!username) {
                return;
            }

            const enabled = isH075895User(username);

            const dcContainer = document.getElementById('dc-number-container');
            if (dcContainer) {
                dcContainer.classList.toggle('hidden', !enabled);
                const dcInput = document.getElementById('dc-number');
                if (!enabled) {
                    if (dcInput) {
                        dcInput.value = '';
                    }
                    if (state && state.invoiceData) {
                        delete state.invoiceData.DC;
                    }
                } else if (dcInput && state && state.invoiceData && typeof state.invoiceData.DC === 'string') {
                    dcInput.value = state.invoiceData.DC;
                }
            }

            const productCodeWrapper = document.getElementById('product-code-wrapper');
            if (productCodeWrapper) {
                productCodeWrapper.classList.toggle('hidden', !enabled);
                if (!enabled) {
                    const productCodeInput = document.getElementById('product-code');
                    if (productCodeInput) {
                        productCodeInput.value = '';
                    }
                }
            }

            const pmCodeWrapper = document.getElementById('pm-code-wrapper');
            if (pmCodeWrapper) {
                pmCodeWrapper.classList.toggle('hidden', !enabled);
                if (!enabled) {
                    const pmCodeInput = document.getElementById('pm-code');
                    if (pmCodeInput) {
                        pmCodeInput.value = '';
                    }
                }
            }

            const toggleModalFieldVisibility = (inputId) => {
                const inputEl = document.getElementById(inputId);
                if (!inputEl || !inputEl.parentElement) {
                    return;
                }
                inputEl.parentElement.classList.toggle('hidden', enabled);
                if (enabled) {
                    inputEl.value = '';
                }
            };

            // Special usernames do not need sale type or SRO details in the product modal
            ['pm-sale-type', 'pm-sro-schedule', 'pm-sro-item'].forEach(toggleModalFieldVisibility);
        }

        function setCurrentUsernameValue(username) {
            if (!username) {
                return;
            }
            currentUsername = username;
            setSRODefaults(currentUsername);
            syncFurtherTaxDefaults();
            applyH075895UI(currentUsername);
        }

        const FURTHER_TAX_CLIENT = '0946915';

        function isFurtherTaxClient() {
            return currentUsername === FURTHER_TAX_CLIENT;
        }

        function isUnregisteredBuyer() {
            const regType = ((state && state.buyerData && state.buyerData.buyerRegistrationType) || '').toString().toLowerCase();
            return regType === 'unregistered';
        }

        function shouldApplyFurtherTax() {
            return isFurtherTaxClient() && isUnregisteredBuyer();
        }

        function getFurtherTaxPercent(item) {
            if (!item) return 0;
            const pctSource = item.furtherTaxPercent !== undefined ? item.furtherTaxPercent : item.furtherTax;
            const pct = parseFloat(pctSource);
            return Number.isFinite(pct) ? pct : 0;
        }

        function computeFurtherTaxAmount(item) {
            if (!shouldApplyFurtherTax()) return 0;
            const base = parseFloat(item && item.valueSalesExcludingST) || 0;
            const pct = getFurtherTaxPercent(item);
            if (base > 0 && pct > 0) {
                return (base * pct) / 100;
            }
            const amt = item && item.furtherTaxAmount;
            return Number.isFinite(parseFloat(amt)) ? parseFloat(amt) : 0;
        }

        function syncFurtherTaxDefaults() {
            const furtherTaxInput = document.getElementById('product-further-tax');
            if (shouldApplyFurtherTax() && furtherTaxInput) {
                const inputVal = parseFloat(furtherTaxInput.value);
                if (!Number.isFinite(inputVal) || inputVal <= 0) {
                    furtherTaxInput.value = '4';
                }
                furtherTaxInput.placeholder = '4';
            }

            if (!shouldApplyFurtherTax()) {
                return;
            }

            if (!state.productItems || state.productItems.length === 0) {
                return;
            }

            let changed = false;
            state.productItems = state.productItems.map((item) => {
                const pct = getFurtherTaxPercent(item);
                if (pct <= 0) {
                    changed = true;
                    return { ...item, furtherTax: 4 };
                }
                return item;
            });

            if (changed) {
                updateTotals();
                updateReviewSection();
            }
        }

        // Notification system
        function showNotification(type, title, message, duration = 3000) {
            const notification = document.getElementById("notification");
            const notificationIcon = document.getElementById("notification-icon");
            const notificationTitle = document.getElementById("notification-title");
            const notificationMessage = document.getElementById(
                "notification-message"
            );

            notification.className = "notification";
            notification.classList.add(`notification-${type}`);

            // Set icon based on type
            if (type === "success") {
                notificationIcon.className = "fas fa-check-circle text-xl";
            } else if (type === "error") {
                notificationIcon.className = "fas fa-exclamation-circle text-xl";
            } else {
                notificationIcon.className = "fas fa-info-circle text-xl";
            }

            notificationTitle.textContent = title;
            notificationMessage.textContent = message;

            // Show notification
            notification.classList.add("show");

            // Hide after duration
            setTimeout(() => {
                notification.classList.remove("show");
            }, duration);
        }

        // Fetch form options from API
        // Function to load draft data
        async function loadDraftInvoice(draftId) {
            try {
                const apiEndpoint = apiUrl(`/api/draft-invoices/${draftId}`);
                console.log(`Loading draft with ID: ${draftId} from endpoint: ${apiEndpoint}`);
                
                const response = await fetch(apiEndpoint);
                console.log(`Draft API response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error || 'Failed to load draft invoice');
                    } catch (jsonError) {
                        throw new Error(`Failed to load draft invoice: Status ${response.status}`);
                    }
                }
                
                const draft = await response.json();
                console.log('Draft data received:', draft);
                
                if (!draft || !draft.id) {
                    throw new Error('Invalid draft data received from server');
                }
                
                // Store draft_id in state
                state.draft_id = draft.id;
                
                // Parse invoice data robustly
                let invoiceData = {};
                try {
                    if (typeof draft.invoice_data === 'string') {
                        try {
                            invoiceData = JSON.parse(draft.invoice_data);
                        } catch (e1) {
                            try {
                                invoiceData = JSON.parse(draft.invoice_data.replace(/'/g, '"'));
                            } catch (e2) {
                                console.warn('Failed to parse draft.invoice_data string, using empty object');
                                invoiceData = {};
                            }
                        }
                    } else if (draft.invoice_data && typeof draft.invoice_data === 'object') {
                        invoiceData = draft.invoice_data;
                    }
                } catch (e) {
                    console.error('Error parsing invoice_data:', e);
                    invoiceData = {};
                }
                
                console.log('Loading draft invoice data:', invoiceData);
                
                // Set up top-level invoice data
                state.invoiceData = {
                    invoiceType: invoiceData.invoiceType || 'Sale Invoice',
                    invoiceDate: invoiceData.invoiceDate || '',
                    invoiceRefNo: invoiceData.invoiceRefNo || invoiceData.invoice_ref_no || '',
                    poNumber: invoiceData.poNumber || invoiceData.PO || '',
                    DC: invoiceData.DC || invoiceData.dcNumber || '',
                    scenarioId: invoiceData.scenarioId || '',
                };
                
                // Populate seller data
                if (invoiceData.sellerData) {
                    const sanitizedSellerTax = normalizeTaxIdValue(invoiceData.sellerData.sellerNTNCNIC || "");
                    state.sellerData = {
                        ...invoiceData.sellerData,
                        sellerNTNCNIC: sanitizedSellerTax,
                    };
                    document.getElementById('seller-business-name').value = state.sellerData.sellerBusinessName || '';
                    document.getElementById('seller-ntn-cnic').value = sanitizedSellerTax;
                    document.getElementById('seller-strn').value = state.sellerData.sellerSTRN || '';
                    document.getElementById('seller-province').value = state.sellerData.sellerProvince || '';
                    document.getElementById('seller-address').value = state.sellerData.sellerAddress || '';
                }
                
                // Populate invoice data fields
                // Keep invoice type in sync (visible and hidden)
                const invType = invoiceData.invoiceType || 'Sale Invoice';
                const invTypeEl = document.getElementById('invoice-type');
                const invTypeHiddenEl = document.getElementById('invoice-type-hidden');
                if (invTypeEl) invTypeEl.value = invType;
                if (invTypeHiddenEl) invTypeHiddenEl.value = invType;
                document.getElementById('invoice-date').value = invoiceData.invoiceDate || '';
                // Correct field id for reference number
                const invoiceRefEl = document.getElementById('invoice-ref-no');
                if (invoiceRefEl) invoiceRefEl.value = invoiceData.invoiceRefNo || invoiceData.invoice_ref_no || '';
                document.getElementById('po-number').value = invoiceData.poNumber || invoiceData.PO || '';
                const dcInput = document.getElementById('dc-number');
                if (dcInput) dcInput.value = invoiceData.DC || invoiceData.dcNumber || '';
                
                // Only set scenario if available and in sandbox environment
                if (ENV === 'sandbox' && invoiceData.scenarioId) {
                    const scenarioEl = document.getElementById('scenario-id');
                    if (scenarioEl) scenarioEl.value = invoiceData.scenarioId;
                }
                
                // Populate buyer data
                if (invoiceData.buyerData) {
                    const sanitizedBuyerTax = normalizeTaxIdValue(invoiceData.buyerData.buyerNTNCNIC || "");
                    state.buyerData = {
                        ...invoiceData.buyerData,
                        buyerNTNCNIC: sanitizedBuyerTax,
                    };
                    document.getElementById('buyer-business-name').value = state.buyerData.buyerBusinessName || '';
                    document.getElementById('buyer-ntn-cnic').value = sanitizedBuyerTax;
                    document.getElementById('buyer-strn').value = state.buyerData.buyerSTRN || '';
                    document.getElementById('buyer-province').value = state.buyerData.buyerProvince || '';
                    document.getElementById('buyer-address').value = state.buyerData.buyerAddress || '';
                    document.getElementById('buyer-registration-type').value = state.buyerData.buyerRegistrationType || '';
                    document.getElementById('buyer-code').value = state.buyerData.buyerCode || '';
                }
                
                // Populate product items with correct field mapping
                state.productItems = []; // Clear existing items

                const normalizeDraftItem = (item = {}) => {
                    const quantity = parseFloat(item.quantity ?? item.qty ?? 0) || 0;
                    const unitRate = parseFloat(item.rate ?? item.unitPrice ?? 0) || 0;
                    const valueExcl = parseFloat(
                        item.valueSalesExcludingST ??
                        item.valueSalesExcludingSt ??
                        item.valueExclTax ??
                        0
                    ) || 0;
                    const salesTax = parseFloat(
                        item.salesTaxApplicable ??
                        item.salesTax ??
                        item.salesTaxCharged ??
                        0
                    ) || 0;
                    const totalValuesRaw = item.totalValues ?? item.total ?? valueExcl + salesTax;
                    const totalValues = Number((Number(totalValuesRaw) || 0).toFixed(2));

                    const furtherTaxPercent = parseFloat(item.furtherTax ?? 0) || 0;
                    const furtherTaxAmount = shouldApplyFurtherTax()
                        ? ((valueExcl * furtherTaxPercent) / 100)
                        : (parseFloat(item.furtherTax) || 0);

                    const normalizedItem = {
                        productDescription: item.productDescription || item.description || '',
                        hsCode: item.hsCode || item.hsCodeNo || '',
                        quantity,
                        uoM: item.uoM || item.uom || item.unit || '',
                        rate: unitRate,
                        valueSalesExcludingST: valueExcl,
                        salesTaxApplicable: salesTax,
                        totalValues,
                        total: parseFloat(item.total ?? totalValues) || totalValues,
                        taxRate: item.taxRate || item.tax_rate || '',
                        saleType:
                            item.saleType ||
                            (invoiceData.scenarioId ? scenarioToSaleType[invoiceData.scenarioId] : '') ||
                            '',
                        sroScheduleNo: item.sroScheduleNo || '',
                        sroItemSerialNo: item.sroItemSerialNo || '',
                        furtherTax: furtherTaxAmount,
                        furtherTaxPercent: furtherTaxPercent,
                        furtherTaxAmount: shouldApplyFurtherTax() ? furtherTaxAmount : undefined,
                        extraTax: item.extraTax ?? '',
                        salesTaxWithheldAtSource: parseFloat(item.salesTaxWithheldAtSource ?? 0) || 0,
                        fedPayable: parseFloat(item.fedPayable ?? 0) || 0,
                        discount: parseFloat(item.discount ?? 0) || 0,
                        fixedNotifiedValueOrRetailPrice: parseFloat(
                            item.fixedNotifiedValueOrRetailPrice ?? item.fixedNotifiedValue ?? 0
                        ) || 0
                    };

                    if (isH075895User()) {
                        normalizedItem.product_code = item.product_code || item.productCode || normalizedItem.product_code || '';
                        normalizedItem.hs_code = item.hs_code || normalizedItem.hsCode || '';
                    }

                    return normalizedItem;
                };

                // Process items based on different possible structures
                if (invoiceData.items && Array.isArray(invoiceData.items)) {
                    state.productItems = invoiceData.items.map(normalizeDraftItem);
                } else if (invoiceData.productItems && Array.isArray(invoiceData.productItems)) {
                    state.productItems = invoiceData.productItems.map(normalizeDraftItem);
                }
                
                // Render the product items in the product table
                renderProductItems();
                
                // Update the review section with the loaded data
                updateReviewSection();
                
                // Skip to review step and mark draft loaded
                goToStep(5);
                state.currentStep = 5;
                
                return true;
            } catch (error) {
                console.error('Error loading draft invoice:', error);
                showNotification('error', 'Error', 'Failed to load draft invoice');
                return false;
            }
        }
        
        async function fetchFormOptions() {
            try {
                const response = await fetch(apiUrl("/api/form-options"));
                if (!response.ok) throw new Error("Failed to fetch form options");

                state.formOptions = await response.json();
                populateFormOptions();

                // Show scenario ID field only in sandbox environment
                if (ENV === "sandbox") {
                    document
                        .getElementById("scenario-id-container")
                        .classList.remove("hidden");
                    document
                        .getElementById("review-scenario-container")
                        .classList.remove("hidden");
                }
            } catch (error) {
                console.error("Error fetching form options:", error);
                showNotification("error", "Error", "Failed to load form options");
            }
        }

        // Fetch business profiles
        async function fetchBusinessProfiles() {
            try {
                const response = await fetch(apiUrl("/api/business-profiles"));
                if (!response.ok)
                    throw new Error("Failed to fetch business profiles");

                const profiles = await response.json();
                const select = document.getElementById("business-profile-select");

                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }

                // Add profiles to select
                profiles.forEach((profile) => {
                    const option = document.createElement("option");
                    option.value = profile.id;
                    option.textContent = profile.business_name;
                    option.dataset.profile = JSON.stringify(profile);
                    select.appendChild(option);

                    // If this is the default profile, select it only when not loading from draft
                    if (profile.is_default && !state.draft_id) {
                        select.value = profile.id;
                        populateSellerForm(profile);
                    }
                });
            } catch (error) {
                console.error("Error fetching business profiles:", error);
                showNotification(
                    "error",
                    "Error",
                    "Failed to load business profiles"
                );
            }
        }

        // Fetch buyers
        async function fetchBuyers() {
            try {
                const response = await fetch(apiUrl("/api/buyers"));
                if (!response.ok) throw new Error("Failed to fetch buyers");

                const buyers = await response.json();
                const select = document.getElementById("buyer-select");

                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }

                // Add buyers to select
                buyers.forEach((buyer) => {
                    const option = document.createElement("option");
                    option.value = buyer.id;
                    option.textContent = buyer.business_name;
                    option.dataset.buyer = JSON.stringify(buyer);
                    select.appendChild(option);

                    // If this is the default buyer, select it
                    if (buyer.is_default) {
                        select.value = buyer.id;
                        populateBuyerForm(buyer);
                    }
                });
            } catch (error) {
                console.error("Error fetching buyers:", error);
                showNotification("error", "Error", "Failed to load buyers");
            }
        }

        // Populate form options
        // Populate form options
        function populateFormOptions() {
            if (!state.formOptions) return;

            // Populate seller province
            const sellerProvince = document.getElementById("seller-province");
            populateSelect(sellerProvince, state.formOptions.provinces);

            // Populate buyer province
            const buyerProvince = document.getElementById("buyer-province");
            populateSelect(buyerProvince, state.formOptions.provinces);

            // Populate buyer registration type
            const buyerRegType = document.getElementById("buyer-registration-type");
            populateSelect(buyerRegType, state.formOptions.registrationTypes);

            // No longer need to populate invoice type as it's now locked
            // const invoiceType = document.getElementById("invoice-type");
            // populateSelect(invoiceType, state.formOptions.invoiceTypes);

            // Populate scenario ID if in sandbox
            if (ENV === "sandbox") {
                const scenarioId = document.getElementById("scenario-id");
                populateSelect(scenarioId, state.formOptions.scenarioIds);
            }

            // Populate product UoM
            const productUom = document.getElementById("product-uom");
            populateSelect(productUom, state.formOptions.uoms);

            // Populate tax rate
            const taxRate = document.getElementById("product-tax-rate");
            populateSelect(taxRate, state.formOptions.taxRates);
        }

        // Helper function to populate select elements
        function populateSelect(selectElement, options) {
            // Keep the first option (placeholder)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            options.forEach((option) => {
                const optElement = document.createElement("option");
                optElement.value = option.value;
                optElement.textContent = option.label;
                selectElement.appendChild(optElement);
            });
        }

        // Populate seller form with selected profile
        function populateSellerForm(profile) {
            const sanitizedNtn = normalizeTaxIdValue(profile.ntn_cnic || "");
            document.getElementById("seller-business-name").value =
                profile.business_name || "";
            document.getElementById("seller-ntn-cnic").value =
                sanitizedNtn;
            document.getElementById("seller-strn").value = profile.strn || "";
            document.getElementById("seller-province").value =
                profile.province || "";
            document.getElementById("seller-address").value = profile.address || "";

            // Update state
            state.sellerData = {
                id: profile.id,
                sellerBusinessName: profile.business_name,
                sellerNTNCNIC: sanitizedNtn,
                sellerSTRN: profile.strn,
                sellerProvince: profile.province,
                sellerAddress: profile.address,
            };
        }
                    syncFurtherTaxDefaults();
        // Populate buyer form with selected buyer
        function populateBuyerForm(buyer) {
            const sanitizedNtn = normalizeTaxIdValue(buyer.ntn_cnic || "");
            document.getElementById("buyer-business-name").value =
                buyer.business_name || "";
            document.getElementById("buyer-ntn-cnic").value = sanitizedNtn;
            document.getElementById("buyer-strn").value = buyer.strn || "";
            document.getElementById("buyer-province").value = buyer.province || "";
            document.getElementById("buyer-registration-type").value =
                buyer.registration_type || "";
            document.getElementById("buyer-code").value = buyer.buyer_code || "";
            document.getElementById("buyer-address").value = buyer.address || "";

            // Update state
            state.buyerData = {
                id: buyer.id,
                buyerBusinessName: buyer.business_name,
                buyerNTNCNIC: sanitizedNtn,
                buyerSTRN: buyer.strn,
                buyerProvince: buyer.province,
                buyerAddress: buyer.address,
                buyerRegistrationType: buyer.registration_type,
                buyerCode: buyer.buyer_code,
            };

            syncFurtherTaxDefaults();
        }

        // (Removed legacy saveBusinessProfile function; modal handles persistence)

        // (Removed legacy saveBuyer function; managed via buyer modal CRUD)

        // Add product item to table
        // Add product item to table
        function addProductItem() {
            calculateValueAndTax();
            const description = document.getElementById("product-description").value;
            const hsCode = document.getElementById("product-hs-code").value;
            const productCodeInput = document.getElementById("product-code");
            const productCode = productCodeInput ? productCodeInput.value.trim() : "";
            const quantity = parseFloat(document.getElementById("product-quantity").value);
            const uom = document.getElementById("product-uom").value;
            const rate = parseFloat(document.getElementById("product-rate").value) || 0;
            const valueExcl = parseFloat(document.getElementById("product-value-excl").value);
            const taxRate = document.getElementById("product-tax-rate").value;
            const taxAmount = parseFloat(document.getElementById("product-tax-amount").value);

            console.log("Adding product:", description);

            // Get scenario-based sale type
            const scenarioId = document.getElementById("scenario-id")?.value;
            const saleType = scenarioToSaleType[scenarioId] || 'Goods at standard rate';

            // Set SRO values based on username
            let sroScheduleNo = '';
            let sroItemSerialNo = '';

            if (currentUsername === '3075270') {
                sroScheduleNo = 'EIGHTH SCHEDULE Table 1';
                sroItemSerialNo = '81';
            } else {
                sroScheduleNo = document.getElementById('product-sro-schedule-no')?.value || '';
                sroItemSerialNo = document.getElementById('product-sro-item-serial-no')?.value || '';
            }

            // Validate required fields
            if (!description || isNaN(quantity) || quantity <= 0 || !uom || isNaN(rate) || rate <= 0 || isNaN(valueExcl) || valueExcl <= 0 || isNaN(taxAmount) || taxAmount < 0) {
                showNotification("error", "Validation Error", "Please fill all required fields with valid values");
                console.error("Validation failed:", {
                    description,
                    quantity: isNaN(quantity) ? "NaN" : quantity,
                    uom,
                    valueExcl: isNaN(valueExcl) ? "NaN" : valueExcl,
                    taxAmount: isNaN(taxAmount) ? "NaN" : taxAmount
                });
                return;
                       }

            // Calculate total
            const total = valueExcl + taxAmount;

            // Get tax rate as displayed in the UI (with % symbol)
            let formattedTaxRate = taxRate;
            if (taxRate && document.getElementById("product-tax-rate").selectedIndex > 0) {
                formattedTaxRate = document.getElementById("product-tax-rate").options[document.getElementById("product-tax-rate").selectedIndex].textContent.trim();
            }
            
            let furtherTaxPercent = parseFloat(document.getElementById('product-further-tax')?.value || 0);
            if (shouldApplyFurtherTax() && (!Number.isFinite(furtherTaxPercent) || furtherTaxPercent <= 0)) {
                furtherTaxPercent = 4;
                const furtherTaxInput = document.getElementById('product-further-tax');
                if (furtherTaxInput) {
                    furtherTaxInput.value = '4';
                }
            }

            const furtherTaxAmount = shouldApplyFurtherTax()
                ? ((parseFloat(valueExcl) || 0) * (furtherTaxPercent || 0)) / 100
                : 0;

            // Create item object with all FBR fields
            const item = {
                productDescription: description,
                hsCode: hsCode,
                quantity: quantity,
                uoM: uom,
                rate: rate,
                valueSalesExcludingST: valueExcl,
                salesTaxApplicable: taxAmount,
                totalValues: total,
                total: total, // Make sure this is set correctly
                saleType: saleType,
                taxRate: formattedTaxRate, // Use the formatted tax rate with % symbol
                sroScheduleNo: sroScheduleNo,
                sroItemSerialNo: sroItemSerialNo,
                furtherTax: furtherTaxAmount,
                furtherTaxPercent: furtherTaxPercent,
                furtherTaxAmount: furtherTaxAmount,
                extraTax: document.getElementById('product-extra-tax')?.value || '',
                salesTaxWithheldAtSource: parseFloat(document.getElementById('product-st-withheld')?.value || 0),
                fedPayable: parseFloat(document.getElementById('product-fed-payable')?.value || 0),
                discount: parseFloat(document.getElementById('product-discount')?.value || 0),
                fixedNotifiedValueOrRetailPrice: parseFloat(document.getElementById('product-fixed-value')?.value || 0)
            };

            if (isH075895User()) {
                item.product_code = productCode;
                item.hs_code = hsCode;
            }

            console.log("Item created:", item);

            // Add item to state
            state.productItems.push(item);
            console.log("State updated, items count:", state.productItems.length);

            // Update table
            updateProductTable();

            // Clear form fields
            document.getElementById("product-description").value = "";
            document.getElementById("product-hs-code").value = "";
            document.getElementById("product-quantity").value = "";
            document.getElementById("product-uom").value = "";
            document.getElementById("product-rate").value = "";
            document.getElementById("product-value-excl").value = "";
            document.getElementById("product-tax-rate").value = "";
            document.getElementById("product-tax-amount").value = "";
            if (productCodeInput) {
                productCodeInput.value = "";
            }

            // Reset SRO fields with proper defaults for the current user
            setSRODefaults(currentUsername);

            // Clear additional FBR fields
            if (document.getElementById('product-further-tax')) document.getElementById('product-further-tax').value = '0';
            if (document.getElementById('product-extra-tax')) document.getElementById('product-extra-tax').value = '';
            if (document.getElementById('product-st-withheld')) document.getElementById('product-st-withheld').value = '0';
            if (document.getElementById('product-fed-payable')) document.getElementById('product-fed-payable').value = '0';
            if (document.getElementById('product-discount')) document.getElementById('product-discount').value = '0';
            if (document.getElementById('product-fixed-value')) document.getElementById('product-fixed-value').value = '0';

            console.log("Form cleared");
        }
        // Alias for updateProductTable for clearer function naming when loading drafts
        function renderProductItems() {
            updateProductTable();
        }
        
        // Update product table
        function updateProductTable() {
            const tableBody = document.getElementById("product-items-table");
            const noProductsRow = document.getElementById("no-products-row");

            // Ensure state.productItems exists
            if (!state.productItems) {
                state.productItems = [];
            }

            if (state.productItems.length > 0) {
                // Hide "no products" row
                if (noProductsRow) {
                    noProductsRow.classList.add("hidden");
                }

                // Clear existing rows but keep the no-products row
                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                // Add the no-products row back (it will be hidden)
                tableBody.appendChild(noProductsRow);

                // Add product rows
                const showFT = shouldApplyFurtherTax();
                // Toggle header visibility based on applicability
                const ftHeader = document.getElementById("product-further-tax-header");
                if (ftHeader) {
                    if (showFT) ftHeader.classList.remove("hidden"); else ftHeader.classList.add("hidden");
                }

                state.productItems.forEach((item, index) => {
                    const row = document.createElement("tr");
                    row.className = "hover:bg-gray-50 transition-colors";
                    
                    // Safely access properties with fallbacks for missing values
                    const productDesc = item.productDescription || '';
                    const hsCode = item.hsCode || '';
                    const quantity = parseFloat(item.quantity) || 0;
                    const uoM = item.uoM || '';
                    const rate = parseFloat(item.rate) || 0;
                    const valueExcl = parseFloat(item.valueSalesExcludingST) || 0;
                    const salesTax = parseFloat(item.salesTaxApplicable) || 0;
                    const furtherTax = computeFurtherTaxAmount(item);
                    const totalValue = valueExcl + salesTax + furtherTax;

                    row.innerHTML = `
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${productDesc}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${hsCode}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${quantity}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${uoM}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${rate.toFixed(2)}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${valueExcl.toFixed(2)}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${salesTax.toFixed(2)}</td>
                ${showFT ? `<td class=\"px-3 py-4 whitespace-nowrap text-sm text-gray-500\">${furtherTax.toFixed(2)}</td>` : ``}
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${totalValue.toFixed(2)}</td>
                <td class="px-3 py-4 whitespace-nowrap text-right text-sm">
                    <button class="delete-product-btn text-red-600 hover:text-red-900" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

                    tableBody.insertBefore(row, noProductsRow);
                });

                // Add event listeners to delete buttons
                document.querySelectorAll(".delete-product-btn").forEach((btn) => {
                    btn.addEventListener("click", function () {
                        try {
                            const index = parseInt(this.getAttribute("data-index"));
                            if (state.productItems && index >= 0 && index < state.productItems.length) {
                                state.productItems.splice(index, 1);
                                updateProductTable();
                                updateTotals();
                            }
                        } catch (error) {
                            console.error("Error deleting product:", error);
                        }
                    });
                });
            } else {
                // Show "no products" row
                if (noProductsRow) {
                    noProductsRow.classList.remove("hidden");
                }
            }

            // Update totals
            updateTotals();

            // Log for debugging
            console.log("Product items in state:", state.productItems.length);
            console.log("Table updated with products");
        }

        // Update totals
        function updateTotals() {
            try {
                // Ensure state.productItems exists
                if (!state.productItems) {
                    state.productItems = [];
                }
                
                const totalValueExcl = state.productItems.reduce(
                    (sum, item) => sum + (parseFloat(item.valueSalesExcludingST) || 0),
                    0
                );
                const totalSalesTax = state.productItems.reduce(
                    (sum, item) => sum + (parseFloat(item.salesTaxApplicable) || 0),
                    0
                );

                const totalFurtherTax = shouldApplyFurtherTax()
                    ? state.productItems.reduce(
                        (sum, item) => sum + (item.furtherTaxAmount !== undefined ? parseFloat(item.furtherTaxAmount) || 0 : computeFurtherTaxAmount(item)),
                        0
                    )
                    : 0;

                const totalTaxAmount = totalSalesTax + totalFurtherTax;
                const grandTotal = totalValueExcl + totalTaxAmount;

                document.getElementById("total-value-excl").textContent =
                    totalValueExcl.toFixed(2);
                document.getElementById("total-tax-amount").textContent =
                    totalTaxAmount.toFixed(2);
                document.getElementById("grand-total").textContent =
                    grandTotal.toFixed(2);
            } catch (error) {
                console.error("Error updating totals:", error);
            }
        }

        // Navigation and step management
        // Navigation and step management
        function goToStep(step) {
            // Hide all steps
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`step-${i}`).classList.add("hidden");
                document.getElementById(`step-${i}-indicator`).className =
                    "step-inactive w-8 h-8 rounded-full flex items-center justify-center";
            }

            // Reset all connecting lines
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step-${i}-${i + 1}-line`).className = "step-line";
            }

            // Show current step
            document.getElementById(`step-${step}`).classList.remove("hidden");

            // Mark completed steps and their connecting lines
            for (let i = 1; i < step; i++) {
                document.getElementById(`step-${i}-indicator`).className =
                    "step-completed w-8 h-8 rounded-full flex items-center justify-center";

                // Mark the connecting line after this step as completed
                if (i < 5) {
                    document.getElementById(`step-${i}-${i + 1}-line`).className =
                        "step-line step-line-completed";
                }
            }

            // Mark current step as active
            document.getElementById(`step-${step}-indicator`).className =
                "step-active w-8 h-8 rounded-full flex items-center justify-center";

            // Update state
            state.currentStep = step;

            // Perform step-specific actions
            if (step === 5) {
                updateReviewSection();
            }
        }

        // Update review section
        function updateReviewSection() {
            try {
                console.log("Updating review section with state:", state);
                
                // Seller information
                if (state.sellerData) {
                    document.getElementById("review-seller-name").textContent =
                        state.sellerData.sellerBusinessName || "";
                    document.getElementById("review-seller-ntn").textContent =
                        state.sellerData.sellerNTNCNIC || "";
                    document.getElementById("review-seller-strn").textContent =
                        state.sellerData.sellerSTRN || "";
                    document.getElementById("review-seller-address").textContent =
                        state.sellerData.sellerAddress || "";
                    document.getElementById("review-seller-province").textContent =
                        state.sellerData.sellerProvince || "";
                }

                // Buyer information
                if (state.buyerData) {
                    document.getElementById("review-buyer-name").textContent =
                        state.buyerData.buyerBusinessName || "";
                    document.getElementById("review-buyer-ntn").textContent =
                        state.buyerData.buyerNTNCNIC || "";
                    document.getElementById("review-buyer-strn").textContent =
                        state.buyerData.buyerSTRN || "";
                    document.getElementById("review-buyer-address").textContent =
                        state.buyerData.buyerAddress || "";
                    document.getElementById("review-buyer-province").textContent =
                        state.buyerData.buyerProvince || "";
                    document.getElementById("review-buyer-registration").textContent =
                        state.buyerData.buyerRegistrationType || "";
                }

                // Invoice details
                if (state.invoiceData) {
                    document.getElementById("review-invoice-type").textContent = 
                        state.invoiceData.invoiceType || "Sale Invoice"; 
                    document.getElementById("review-invoice-date").textContent =
                        state.invoiceData.invoiceDate || "";
                    document.getElementById("review-invoice-ref").textContent =
                        state.invoiceData.invoiceRefNo || "";
                    document.getElementById("review-po-number").textContent =
                        state.invoiceData.poNumber || state.invoiceData.PO || "";
                }
                
                // Validate product items to ensure they have required properties
                if (!state.productItems) {
                    state.productItems = [];
                } else {
                    // Normalize numeric fields but PRESERVE all existing properties (e.g., SRO fields)
                    state.productItems = state.productItems.map(item => ({
                        ...item,
                        productDescription: item.productDescription || '',
                        hsCode: item.hsCode || '',
                        uoM: item.uoM || '',
                        quantity: parseFloat(item.quantity) || 0,
                        rate: parseFloat(item.rate) || 0,
                        valueSalesExcludingST: parseFloat(item.valueSalesExcludingST) || 0,
                        salesTaxApplicable: parseFloat(item.salesTaxApplicable) || 0
                    }));
                }
            } catch (error) {
                console.error("Error updating review section:", error);
            }

            // Add this block for delivery challan review
            const reviewDeliveryChallanContainer = document.getElementById('review-delivery-challan-container');
            if (reviewDeliveryChallanContainer) {
                if (currentUsername === '8974121') {
                    document.getElementById('review-delivery-challan').textContent =
                        state.invoiceData.CNIC || "";
                    reviewDeliveryChallanContainer.classList.remove('hidden');
                } else {
                    reviewDeliveryChallanContainer.classList.add('hidden');
                }
            }

            if (ENV === "sandbox" && state.invoiceData.scenarioId) {
                document.getElementById("review-scenario-id").textContent =
                    state.invoiceData.scenarioId;
                document
                    .getElementById("review-scenario-container")
                    .classList.remove("hidden");
            } else {
                document
                    .getElementById("review-scenario-container")
                    .classList.add("hidden");
            }

            // Totals
            document.getElementById("review-items-count").textContent =
                state.productItems ? state.productItems.length : 0;

            const totalValueExcl = state.productItems ? state.productItems.reduce(
                (sum, item) => sum + (parseFloat(item.valueSalesExcludingST) || 0),
                0
            ) : 0;
            
            const totalSalesTax = state.productItems ? state.productItems.reduce(
                (sum, item) => sum + (parseFloat(item.salesTaxApplicable) || 0),
                0
            ) : 0;

            const totalFurtherTax = shouldApplyFurtherTax() && state.productItems ? state.productItems.reduce(
                (sum, item) => sum + (item.furtherTaxAmount !== undefined ? parseFloat(item.furtherTaxAmount) || 0 : computeFurtherTaxAmount(item)),
                0
            ) : 0;
            
            const totalTaxAmount = totalSalesTax + totalFurtherTax;
            const grandTotal = totalValueExcl + totalTaxAmount;

            document.getElementById("review-value-excl").textContent =
                totalValueExcl.toFixed(2);
            document.getElementById("review-tax-amount").textContent =
                totalTaxAmount.toFixed(2);
            document.getElementById("review-grand-total").textContent =
                grandTotal.toFixed(2);

            // Toggle and set Further Tax in review totals
            const ftRow = document.getElementById("review-further-tax-row");
            const ftVal = document.getElementById("review-further-tax");
            if (ftRow && ftVal) {
                if (shouldApplyFurtherTax()) {
                    ftRow.classList.remove("hidden");
                    ftVal.textContent = totalFurtherTax.toFixed(2);
                } else {
                    ftRow.classList.add("hidden");
                    ftVal.textContent = "0.00";
                }
            }

            // Product items
            const tableBody = document.getElementById("review-items-table");
            const noProductsRow = document.getElementById("review-no-products-row");

            if (state.productItems && state.productItems.length > 0) {
                // Hide "no products" row
                if (noProductsRow) noProductsRow.classList.add("hidden");

                // Clear existing rows
                tableBody.innerHTML = "";

                // Toggle header visibility based on applicability
                const showFT = shouldApplyFurtherTax();
                const ftHeader = document.getElementById("review-further-tax-header");
                if (ftHeader) {
                    if (showFT) ftHeader.classList.remove("hidden"); else ftHeader.classList.add("hidden");
                }

                // Add product rows
                state.productItems.forEach((item) => {
                    const row = document.createElement("tr");
                    row.className = "hover:bg-gray-50 transition-colors";
                    
                    // Safely access properties with fallbacks for missing values
                    const productDesc = item.productDescription || '';
                    const hsCode = item.hsCode || '';
                    const quantity = parseFloat(item.quantity) || 0;
                    const uoM = item.uoM || '';
                    const rate = parseFloat(item.rate) || 0;
                    const valueExcl = parseFloat(item.valueSalesExcludingST) || 0;
                    const salesTax = parseFloat(item.salesTaxApplicable) || 0;
                    const furtherTax = computeFurtherTaxAmount(item);
                    const totalValue = valueExcl + salesTax + furtherTax;

                    row.innerHTML = `
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${productDesc}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${hsCode}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${quantity}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${uoM}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${rate.toFixed(2)}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${valueExcl.toFixed(2)}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${salesTax.toFixed(2)}</td>
                ${showFT ? `<td class=\"px-3 py-4 whitespace-nowrap text-sm text-gray-500\">${furtherTax.toFixed(2)}</td>` : ``}
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${totalValue.toFixed(2)}</td>
            `;

                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `
            <tr id="review-no-products-row">
                <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                    No products added yet.
                </td>
            </tr>
        `;
            }
        }

        // Validate form steps
        function validateStep(step) {
            switch (step) {
                case 1:
                    // Validate seller information
                    const sellerName = document.getElementById("seller-business-name").value;
                    const sellerNtnInput = document.getElementById("seller-ntn-cnic");
                    const sellerNtn = sellerNtnInput.value;
                    const sellerProvince = document.getElementById("seller-province").value;
                    const sellerAddress = document.getElementById("seller-address").value;

                    if (!sellerName || !sellerNtn || !sellerProvince || !sellerAddress) {
                        showNotification(
                            "error",
                            "Validation Error",
                            "Please fill all required seller fields"
                        );
                        return false;
                    }

                    const normalizedSellerNtn = enforceTaxIdOnInput(sellerNtnInput, "Seller NTN/CNIC");
                    if (!normalizedSellerNtn) {
                        return false;
                    }

                    // Update state
                    state.sellerData = {
                        sellerBusinessName: sellerName,
                        sellerNTNCNIC: normalizedSellerNtn,
                        sellerSTRN: document.getElementById("seller-strn").value,
                        sellerProvince: sellerProvince,
                        sellerAddress: sellerAddress,
                    };

                    return true;


                case 2:
                    // Validate invoice details
                    const invoiceDate = document.getElementById("invoice-date").value;

                    if (!invoiceDate) {
                        showNotification(
                            "error",
                            "Validation Error",
                            "Please fill in the invoice date"
                        );
                        return false;
                    }

                    // Update state - use hidden field value for invoice type
                    state.invoiceData = {
                        invoiceType: document.getElementById("invoice-type-hidden").value, // "Sale Invoice"
                        invoiceDate: invoiceDate,
                        invoiceRefNo: document.getElementById("invoice-ref-no").value,
                        poNumber: document.getElementById("po-number").value,
                    };

                    // Add delivery challan for specific user
                    if (currentUsername === '8974121' && document.getElementById("delivery-challan")) {
                        state.invoiceData.CNIC = document.getElementById("delivery-challan").value;
                    }

                    // Add scenario ID if in sandbox
                    if (ENV === "sandbox") {
                        state.invoiceData.scenarioId =
                            document.getElementById("scenario-id").value;
                    }

                    if (isH075895User()) {
                        const dcInput = document.getElementById("dc-number");
                        state.invoiceData.DC = dcInput ? dcInput.value.trim() : "";
                    } else if (state.invoiceData) {
                        delete state.invoiceData.DC;
                    }

                    return true;

                case 3:
                    // Validate buyer information
                    const buyerName = document.getElementById(
                        "buyer-business-name"
                    ).value;
                    const buyerNtnInput = document.getElementById("buyer-ntn-cnic");
                    const buyerNtn = buyerNtnInput.value;
                    const buyerProvince =
                        document.getElementById("buyer-province").value;
                    const buyerAddress = document.getElementById("buyer-address").value;
                    const buyerRegType = document.getElementById(
                        "buyer-registration-type"
                    ).value;

                    if (
                        !buyerName ||
                        !buyerNtn ||
                        !buyerProvince ||
                        !buyerAddress ||
                        !buyerRegType
                    ) {
                        showNotification(
                            "error",
                            "Validation Error",
                            "Please fill all required buyer fields"
                        );
                        return false;
                    }

                    const normalizedBuyerNtn = enforceTaxIdOnInput(buyerNtnInput, "Buyer NTN/CNIC");
                    if (!normalizedBuyerNtn) {
                        return false;
                    }

                    // Update state
                    state.buyerData = {
                        buyerBusinessName: buyerName,
                        buyerNTNCNIC: normalizedBuyerNtn,
                        buyerSTRN: document.getElementById("buyer-strn").value,
                        buyerProvince: buyerProvince,
                        buyerAddress: buyerAddress,
                        buyerRegistrationType: buyerRegType,
                        buyerCode: document.getElementById("buyer-code").value,
                    };

                    syncFurtherTaxDefaults();

                    return true;

                case 4:
                    // Validate products
                    if (state.productItems.length === 0) {
                        showNotification(
                            "error",
                            "Validation Error",
                            "Please add at least one product"
                        );
                        return false;
                    }

                    return true;

                default:
                    return true;
            }
        }

        // Submit invoice
        // Submit invoice
        async function submitInvoice(saveDraft = false, extraOptions = {}) {
            try {
                // Prepare data
                const preparedItems = (state.productItems || []).map((item) => {
                    const cloned = { ...item };
                    if (isH075895User()) {
                        const resolvedHsCode = cloned.hs_code || cloned.hsCode || '';
                        const resolvedProductCode = cloned.product_code || cloned.productCode || '';
                        cloned.product_code = resolvedProductCode;
                        cloned.hs_code = resolvedHsCode;
                    } else {
                        delete cloned.product_code;
                        delete cloned.hs_code;
                    }
                    return cloned;
                });

                const sellerTaxId = getValidTaxId(state.sellerData && state.sellerData.sellerNTNCNIC);
                const buyerTaxId = getValidTaxId(state.buyerData && state.buyerData.buyerNTNCNIC);
                if (!sellerTaxId || !buyerTaxId) {
                    showNotification(
                        "error",
                        "Validation Error",
                        "Seller and buyer NTN/CNIC must be 7 characters (NTN) or 13 digits (CNIC)"
                    );
                    throw new Error("Invalid tax identifiers");
                }
                state.sellerData.sellerNTNCNIC = sellerTaxId;
                state.buyerData.buyerNTNCNIC = buyerTaxId;

                const invoiceData = {
                    invoiceType: state.invoiceData.invoiceType,
                    invoiceDate: state.invoiceData.invoiceDate,
                    invoiceRefNo: state.invoiceData.invoiceRefNo,
                    poNumber: state.invoiceData.poNumber,
                    sellerData: state.sellerData,
                    buyerData: state.buyerData,
                    items: preparedItems,
                    saveDraft: saveDraft,
                    submit: !saveDraft,
                };

                if (isH075895User()) {
                    invoiceData.DC = state.invoiceData.DC || "";
                }

                if (saveDraft) {
                    if (extraOptions.title) {
                        invoiceData.title = extraOptions.title;
                    }
                    invoiceData.original_env = extraOptions.original_env || ENV;
                }

                // Include draft_id if this invoice was loaded from a draft
                if (state.draft_id) {
                    invoiceData.draft_id = state.draft_id;
                }

                if (ENV === "sandbox" && state.invoiceData.scenarioId) {
                    invoiceData.scenarioId = state.invoiceData.scenarioId;
                }

                // Send to API
                const response = await fetch(apiUrl("/api/invoice/create"), {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(invoiceData),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || "Failed to submit invoice");
                }

                if (saveDraft) {
                    const titleSuffix = extraOptions.title
                        ? ` with title "${extraOptions.title}"`
                        : "";
                    showNotification(
                        "success",
                        "Draft Saved",
                        `Invoice has been saved as draft${titleSuffix}`
                    );
                } else {
                    showNotification(
                        "success",
                        "Invoice Submitted",
                        "Invoice has been submitted to FBR"
                    );
                    // Don't redirect immediately so user can see response in modal
                }

                return result;
            } catch (error) {
                console.error("Error submitting invoice:", error);
                showNotification(
                    "error",
                    "Error",
                    error.message || "Failed to submit invoice"
                );
                throw error;
            }
        }

        // View JSON button
        document.getElementById("view-json-btn").addEventListener("click", function () {
            // Add loading animation before showing JSON
            const jsonValidateStatus = document.getElementById('json-validate-status');
            if (jsonValidateStatus) {
                jsonValidateStatus.innerHTML =
                    `<i class="fas fa-circle-notch fa-spin text-blue-500 mr-1"></i>Validating...`;
            }

            // Create JSON modal if it doesn't exist
            let jsonModal = document.getElementById("json-preview-modal");
            if (!jsonModal) {
                jsonModal = document.createElement("div");
                jsonModal.id = "json-preview-modal";
                jsonModal.className = "fixed inset-0 z-50 flex items-center justify-center hidden";
                jsonModal.innerHTML = `
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-3xl max-h-screen overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Invoice JSON Data</h3>
                    <button id="close-json-preview-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <textarea id="json-preview-textarea"
                        class="w-full h-64 p-3 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500 font-mono text-sm"
                        readonly></textarea>
                </div>
                <div class="flex justify-end">
                    <button id="close-json-preview-btn"
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
                document.body.appendChild(jsonModal);

                // Add event listeners to close buttons
                document
                    .getElementById("close-json-preview-modal")
                    .addEventListener("click", function () {
                        document
                            .getElementById("json-preview-modal")
                            .classList.add("hidden");
                    });

                document
                    .getElementById("close-json-preview-btn")
                    .addEventListener("click", function () {
                        document
                            .getElementById("json-preview-modal")
                            .classList.add("hidden");
                    });
            }

            // Prepare data for JSON preview with all required FBR fields exactly matching their expected format
            const invoiceData = {
                "invoiceType": state.invoiceData.invoiceType || "Sale Invoice",
                "invoiceDate": state.invoiceData.invoiceDate || "yyyy-MM-dd",
                "sellerNTNCNIC": state.sellerData.sellerNTNCNIC || "0000000000000",
                "sellerBusinessName": state.sellerData.sellerBusinessName || "Your Business Name",
                "sellerProvince": state.sellerData.sellerProvince || "Seller Province",
                "sellerAddress": state.sellerData.sellerAddress || "Seller Address",
                "buyerNTNCNIC": state.buyerData.buyerNTNCNIC || "0000000000000",
                "buyerBusinessName": state.buyerData.buyerBusinessName || "Buyer Business Name",
                "buyerProvince": state.buyerData.buyerProvince || "Buyer Province",
                "buyerAddress": state.buyerData.buyerAddress || "Buyer Address",
                "buyerRegistrationType": state.buyerData.buyerRegistrationType || "Registered",
                "invoiceRefNo": state.invoiceData.invoiceRefNo || "",
            };

            // Add scenario ID if in sandbox
            if (ENV === "sandbox") {
                invoiceData.scenarioId = state.invoiceData.scenarioId || "SN000";
            }

            // Format items array exactly as FBR expects
            invoiceData.items = state.productItems.map((item) => {
                // Resolve tax rate from the item or derive from values to avoid incorrect 0%
                let taxRateStr = '';
                let raw = item.taxRate ?? item.tax_rate ?? item.rateTax ?? '';
                if (raw !== undefined && raw !== null && String(raw).toString().trim() !== '') {
                    // Normalize to a string with % and two decimals
                    if (typeof raw === 'number') {
                        taxRateStr = `${raw.toFixed(2)}%`;
                    } else {
                        let s = String(raw).trim();
                        if (s.endsWith('%')) {
                            const num = parseFloat(s.replace('%',''));
                            taxRateStr = isNaN(num) ? s : `${num.toFixed(2)}%`;
                        } else {
                            const num = parseFloat(s);
                            taxRateStr = isNaN(num) ? s : `${num.toFixed(2)}%`;
                        }
                    }
                } else {
                    // Derive from salesTaxApplicable and valueSalesExcludingST when explicit rate isn't stored
                    const base = parseFloat(item.valueSalesExcludingST) || 0;
                    const tax = parseFloat(item.salesTaxApplicable) || 0;
                    if (base > 0 && tax >= 0) {
                        const pct = (tax / base) * 100;
                        taxRateStr = `${pct.toFixed(2)}%`;
                    } else {
                        taxRateStr = '0%';
                    }
                }

                // Ensure numeric fields are numbers and compute totalValues here
                const qty = parseFloat(item.quantity) || 0;
                const valueExcl = Number((parseFloat(item.valueSalesExcludingST) || 0).toFixed(2));
                const salesTax = Number((parseFloat(item.salesTaxApplicable) || 0).toFixed(2));
                const totalValues = Number((valueExcl + salesTax).toFixed(2));
                const furtherTaxAmount = shouldApplyFurtherTax()
                    ? ((item.furtherTaxAmount !== undefined ? parseFloat(item.furtherTaxAmount) : computeFurtherTaxAmount(item)) || 0)
                    : (parseFloat(item.furtherTax) || 0);

                return {
                    "hsCode": item.hsCode || "0000.0000",
                    "productDescription": item.productDescription || "",
                    "rate": taxRateStr,
                    "uoM": item.uoM || "",
                    "quantity": qty,
                    "totalValues": totalValues,
                    "valueSalesExcludingST": valueExcl,
                    "fixedNotifiedValueOrRetailPrice": item.fixedNotifiedValueOrRetailPrice || 0,
                    "salesTaxApplicable": salesTax,
                    "salesTaxWithheldAtSource": item.salesTaxWithheldAtSource || 0,
                    "extraTax": item.extraTax || "",
                    "furtherTax": Number(furtherTaxAmount.toFixed(2)),
                    "sroScheduleNo": item.sroScheduleNo || "",
                    "fedPayable": item.fedPayable || 0,
                    "discount": item.discount || 0,
                    "saleType": item.saleType || "Goods at Reduced Rate",
                    "sroItemSerialNo": item.sroItemSerialNo || ""
                };
            });

            // If there are no items, add a default empty one
            if (invoiceData.items.length === 0) {
                // Get the current default tax rate from the dropdown
                let defaultRate = "0%";
                const taxRateSelect = document.getElementById('product-tax-rate');
                if (taxRateSelect && taxRateSelect.selectedIndex > 0) {
                    defaultRate = taxRateSelect.options[taxRateSelect.selectedIndex].textContent.trim();
                }

                // Provide a safe default item shape (no undefined references)
                invoiceData.items = [{
                    "hsCode": "0000.0000",
                    "productDescription": "",
                    "rate": defaultRate,
                    "uoM": "",
                    "quantity": 0,
                    "totalValues": 0,
                    "valueSalesExcludingST": 0,
                    "fixedNotifiedValueOrRetailPrice": 0,
                    "salesTaxApplicable": 0,
                    "salesTaxWithheldAtSource": 0,
                    "extraTax": "",
                    "furtherTax": 0,
                    "sroScheduleNo": "",
                    "fedPayable": 0,
                    "discount": 0,
                    "saleType": "",
                    "sroItemSerialNo": ""
                }];
            }

            // Display JSON in the modal with exact formatting
            document.getElementById("json-preview-textarea").value = JSON.stringify(invoiceData, null, 2);
            document.getElementById("json-preview-modal").classList.remove("hidden");

            // Show success message under the button after a brief delay
            setTimeout(() => {
                if (jsonValidateStatus) {
                    jsonValidateStatus.innerHTML =
                        `<i class="fas fa-check-circle text-green-600 mr-1"></i>JSON validated successfully`;
                }
            }, 800);
        });        // Auto-calculate rate when quantity or value excluding sales tax changes

        function calculateValueAndTax() {
            const qtyEl = document.getElementById('product-quantity'); const rateEl = document.getElementById('product-rate'); const valueEl = document.getElementById('product-value-excl'); const taxRateSelect = document.getElementById('product-tax-rate'); const taxAmtEl = document.getElementById('product-tax-amount');
            if (!qtyEl || !rateEl || !valueEl || !taxRateSelect || !taxAmtEl) return;

            const qty = parseFloat(qtyEl.value) || 0;
            const ratePerUnit = parseFloat(rateEl.value) || 0;

            const valueExcl = qty * ratePerUnit;
            if (qty > 0 && ratePerUnit > 0) {
                valueEl.value = valueExcl.toFixed(2);
            } else {
                valueEl.value = "";
                taxAmtEl.value = "";
                return;
            }

            let taxPercent = 0;
            if (taxRateSelect.selectedIndex > 0) {
                const optText = taxRateSelect.options[taxRateSelect.selectedIndex].textContent.trim();
                taxPercent = parseFloat(optText.replace('%', '')) || 0;
            }
            const taxAmount = valueExcl * (taxPercent / 100);
            taxAmtEl.value = taxAmount.toFixed(2);
        }



        // Event Listeners
        document.addEventListener("DOMContentLoaded", function () {
            // Debug logging for URL parameters and environment
            console.log('URL parameters:', window.location.search);
            console.log('Environment from constant:', ENV);
            console.log('Environment from URL:', getUrlParameter('env'));
            
            // Check if we should load a draft
            const draftIdFromUrl = getUrlParameter('load_draft');
            console.log('Draft ID from URL:', draftIdFromUrl);
            
            // Fetch data
            fetchUsername();
            fetchFormOptions();
            fetchBusinessProfiles();
            fetchBuyers();
            initUserSpecificFields();
            
            // If draft ID is present, load the draft after other initializations are done
            if (draftIdFromUrl) {
                console.log(`Draft ID detected in URL: ${draftIdFromUrl}`);
                // Use setTimeout to ensure all other initializations are complete
                setTimeout(() => {
                    loadDraftInvoice(draftIdFromUrl)
                        .then(success => {
                            if (success) {
                                showNotification("success", "Draft Loaded", "Draft invoice loaded successfully and ready for review");
                                // Fallback guard: ensure we remain on Review step even if other code resets steps
                                setTimeout(() => {
                                    if (state && state.draft_id) {
                                        goToStep(5);
                                    }
                                }, 400);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading draft:', error);
                            showNotification("error", "Loading Error", error.message || "Failed to load draft invoice");
                        });
                }, 1000); // Increased timeout to ensure all initializations complete
            }

            // Mobile menu toggle
            const mobileMenuButton = document.getElementById("mobile-menu-button");
            const closeMobileMenuButton =
                document.getElementById("close-mobile-menu");
            const mobileMenu = document.getElementById("mobile-menu");

            if (mobileMenuButton && closeMobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener("click", function () {
                    mobileMenu.classList.remove("hidden");
                });

                closeMobileMenuButton.addEventListener("click", function () {
                    mobileMenu.classList.add("hidden");
                });
            }


            // Business profile select change
            document
                .getElementById("business-profile-select")
                .addEventListener("change", function () {
                    if (this.value) {
                        const profileData = JSON.parse(
                            this.options[this.selectedIndex].dataset.profile
                        );
                        populateSellerForm(profileData);
                    }
                });

            // Add business profile button
            document
                .getElementById("add-business-profile-btn")
                .addEventListener("click", function () {
                    document.getElementById("business-profile-select").value = "";
                    document.getElementById("seller-business-name").value = "";
                    document.getElementById("seller-ntn-cnic").value = "";
                    document.getElementById("seller-strn").value = "";
                    document.getElementById("seller-province").value = "";
                    document.getElementById("seller-address").value = "";
                    // (Removed legacy auto-check of save-business-profile)
                });

            // Buyer select change
            document
                .getElementById("buyer-select")
                .addEventListener("change", function () {
                    if (this.value) {
                        const buyerData = JSON.parse(
                            this.options[this.selectedIndex].dataset.buyer
                        );
                        populateBuyerForm(buyerData);
                    }
                });

            const buyerRegSelect = document.getElementById("buyer-registration-type");
            if (buyerRegSelect) {
                buyerRegSelect.addEventListener("change", function () {
                    state.buyerData = state.buyerData || {};
                    state.buyerData.buyerRegistrationType = this.value;
                    syncFurtherTaxDefaults();
                });
            }

            // Buyer plus button now opens buyer management modal
            document.getElementById("add-buyer-btn")?.addEventListener("click", function(){ openBuyerModal(); });

            // Add product item button
            document
                .getElementById("add-product-item-btn")
                .addEventListener("click", addProductItem);

            // Tax calculation helpers
            document
                .getElementById("product-value-excl")
                .addEventListener("input", function () {
                    const valueExcl = parseFloat(this.value) || 0;
                    const taxRateSelect = document.getElementById("product-tax-rate");
                    const taxRateText =
                        taxRateSelect.options[taxRateSelect.selectedIndex].textContent;
                    const taxRate = parseFloat(taxRateText) || 0;

                    const taxAmount = valueExcl * (taxRate / 100);
                    document.getElementById("product-tax-amount").value =
                        taxAmount.toFixed(2);
                });

            document
                .getElementById("product-tax-rate")
                .addEventListener("change", function () {
                    const valueExcl =
                        parseFloat(document.getElementById("product-value-excl").value) ||
                        0;
                    const taxRateText = this.options[this.selectedIndex].textContent;
                    const taxRate = parseFloat(taxRateText) || 0;

                    const taxAmount = valueExcl * (taxRate / 100);
                    document.getElementById("product-tax-amount").value =
                        taxAmount.toFixed(2);
                });

            // Real-time recalculation when typing quantity or rate, or changing tax rate
            const qtyInput = document.getElementById('product-quantity');
            const rateInput = document.getElementById('product-rate');
            const taxRateSelect = document.getElementById('product-tax-rate');
            if(qtyInput){
                qtyInput.addEventListener('input', () => { calculateValueAndTax(); });
            }
            if(rateInput){
                rateInput.addEventListener('input', () => { calculateValueAndTax(); });
            }
            if(taxRateSelect){
                taxRateSelect.addEventListener('input', () => { calculateValueAndTax(); });
            }

            // Navigation buttons
            document
                .getElementById("step1-next")
                .addEventListener("click", function () {
                    if (validateStep(1)) {
                        goToStep(2);
                    }
                });

            document
                .getElementById("step2-prev")
                .addEventListener("click", function () {
                    goToStep(1);
                });

            document
                .getElementById("step2-next")
                .addEventListener("click", function () {
                    if (validateStep(2)) {
                        goToStep(3);
                    }
                });

            document
                .getElementById("step3-prev")
                .addEventListener("click", function () {
                    goToStep(2);
                });

            document
                .getElementById("step3-next")
                .addEventListener("click", function () {
                    if (validateStep(3)) {
                        goToStep(4);
                    }
                });

            document
                .getElementById("step4-prev")
                .addEventListener("click", function () {
                    goToStep(3);
                });

            document
                .getElementById("step4-next")
                .addEventListener("click", async function () {
                    if (validateStep(4)) {
                        await saveProductsIfChecked();
                        goToStep(5);
                    }
                });

            document
                .getElementById("step5-prev")
                .addEventListener("click", function () {
                    goToStep(4);
                });

            // Submit button handler - Only include ONE submit button handler
            document.getElementById("submit-invoice-btn").addEventListener("click", function () {
                // Store original button content and disable button
                const submitBtn = this;
                const originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i>Submitting...`;
                submitBtn.disabled = true;

                // Create submission modal if it doesn't exist
                let submissionModal = document.getElementById("fbr-submission-modal");
                if (!submissionModal) {
                    submissionModal = document.createElement("div");
                    submissionModal.id = "fbr-submission-modal";
                    submissionModal.className = "fixed inset-0 z-50 flex items-center justify-center hidden";
                    submissionModal.innerHTML = `
    <div class="modal-overlay absolute inset-0"></div>
    <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-md">
        <div class="p-6 text-center">
            <div id="submission-loading" class="flex flex-col items-center">
                <div class="mb-4">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-primary-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Submitting to FBR</h3>
                <p class="text-gray-600">Please wait while we process your request...</p>
            </div>
            <div id="submission-success" class="hidden">
                <svg class="checkmark mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" width="70">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                </svg>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Submitted Successfully!</h3>
                <p class="text-gray-600">Your data has been successfully submitted to FBR.</p>
                <p id="invoice-number-display" class="mt-2 font-bold text-primary-700"></p>
                <div class="mt-4 p-4 bg-gray-100 rounded-md text-sm max-h-40 overflow-auto">
                    <pre id="success-response-data" class="text-left"></pre>
                </div>
            </div>
            <div id="submission-error" class="hidden">
                <svg class="crossmark mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" width="70">
                    <circle class="crossmark__circle" cx="26" cy="26" r="25" fill="none" />
                    <path class="crossmark__cross" fill="none" d="M16 16 36 36 M36 16 16 36" />
                </svg>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Submission Failed</h3>
                <p class="text-gray-600 mb-2">There was an error submitting your data.</p>
                <div class="mt-2 p-4 bg-gray-100 rounded-md text-sm max-h-40 overflow-auto">
                    <pre id="error-response-data" class="text-left text-red-600"></pre>
                </div>
            </div>
            <div class="mt-6">
                <button id="close-submission-modal" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700">
                    Close
                </button>
            </div>
        </div>
    </div>
`;
                    document.body.appendChild(submissionModal);

                    // Add event listener to close button
                    document.getElementById("close-submission-modal").addEventListener("click", function () {
                        document.getElementById("fbr-submission-modal").classList.add("hidden");
                        // We're removing the redirect to dashboard
                    });
                }

                // Show the loading state of the modal
                submissionModal.classList.remove("hidden");
                document.getElementById("submission-loading").style.display = "flex";
                document.getElementById("submission-success").classList.add("hidden");
                document.getElementById("submission-error").classList.add("hidden");

                // Submit the invoice
                submitInvoice(false)
                    .then(result => {
                        // Hide loading
                        document.getElementById("submission-loading").style.display = "none";

                        // Show success if we have invoice number
                        if (result && result.invoiceNumber && result.invoiceNumber !== "N/A") {
                            document.getElementById("submission-success").classList.remove("hidden");
                            document.getElementById("invoice-number-display").textContent = `Invoice Number: ${result.invoiceNumber}`;
                            document.getElementById("success-response-data").textContent = JSON.stringify(result, null, 2);

                            // Enable the Generate Invoice button after successful submission
                            document.getElementById("generate-invoice-btn").disabled = false;
                            document.getElementById("generate-invoice-btn").classList.remove("opacity-50", "cursor-not-allowed");
                        } else {
                            document.getElementById("submission-error").classList.remove("hidden");
                            document.getElementById("error-response-data").textContent = JSON.stringify(result, null, 2);

                            // Keep Generate Invoice button disabled on failure
                            document.getElementById("generate-invoice-btn").disabled = true;
                            document.getElementById("generate-invoice-btn").classList.add("opacity-50", "cursor-not-allowed");
                        }
                    })
                    .catch(error => {
                        // Hide loading and show error
                        document.getElementById("submission-loading").style.display = "none";
                        document.getElementById("submission-error").classList.remove("hidden");
                        document.getElementById("error-response-data").textContent = error.message || "Unknown error occurred";

                        // Keep Generate Invoice button disabled on error
                        document.getElementById("generate-invoice-btn").disabled = true;
                        document.getElementById("generate-invoice-btn").classList.add("opacity-50", "cursor-not-allowed");
                    })
                    .finally(() => {
                        // Reset button state
                        submitBtn.innerHTML = originalContent;
                        submitBtn.disabled = false;
                    });
            });

            // Generate Invoice button handler - This is a SEPARATE handler
            document.getElementById('generate-invoice-btn').addEventListener('click', function () {
                const btn = this;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i>Generating...`;
                btn.disabled = true;

                // Use the current form data to generate PDF
                fetch(apiUrl('/api/generate-form-invoice'))
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => { throw new Error(data.error || 'Failed to generate PDF'); });
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'invoice.pdf';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);

                        // Reset button
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;

                        showNotification('success', 'PDF Generated', 'Invoice PDF has been generated successfully.');
                    })
                    .catch(error => {
                        // Reset button
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;

                        showNotification('error', 'PDF Generation Failed', error.message);
                    });
            });

            // Save Draft button
            // Replace the existing save-draft-btn event listener with this:
            document.getElementById("save-draft-btn").addEventListener("click", function () {
                // Show the modal instead of using prompt
                document.getElementById("save-draft-modal").classList.remove("hidden");
            });

            // Add these event listeners for the modal
            document.getElementById("close-save-draft-modal").addEventListener("click", function () {
                document.getElementById("save-draft-modal").classList.add("hidden");
            });

            document.getElementById("cancel-save-draft").addEventListener("click", function () {
                document.getElementById("save-draft-modal").classList.add("hidden");
            });

            document.getElementById("confirm-save-draft").addEventListener("click", async function () {
                const titleInput = document.getElementById("draft-invoice-title");
                const title = titleInput.value.trim();

                // Hide the modal
                document.getElementById("save-draft-modal").classList.add("hidden");

                try {
                    await submitInvoice(true, { title, original_env: ENV });
                } catch (error) {
                    console.error("Error saving draft:", error);
                } finally {
                    titleInput.value = "";
                }
            });

            // Scenario select change
            const scenarioSelect = document.getElementById("scenario-id");
            if (scenarioSelect) {
                scenarioSelect.addEventListener("change", function () {
                    const selectedScenario = this.value;
                    const saleType = scenarioToSaleType[selectedScenario] || '';
                    const saleTypeInput = document.getElementById("product-sale-type");
                    if (saleTypeInput) {
                        saleTypeInput.value = saleType;
                    }
                });
            }

            // Initialize the Generate Invoice button as disabled until submission is successful
            const generateBtn = document.getElementById("generate-invoice-btn");
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.classList.add("opacity-50", "cursor-not-allowed");
            }

            ensureCurrentUsername().catch(() => {});
        });

        // Product management
        let useProductDropdown = true;
        let productList = [];
        let productMenuOpen = false;

        // Ensure SRO defaults helper exists
        function setSRODefaults(username){
            const schedEl=document.getElementById('product-sro-schedule-no');
            const itemEl=document.getElementById('product-sro-item-serial-no');
            if(!schedEl||!itemEl) return;
            if(username==='3075270'){
                // Hard-coded defaults per original logic
                schedEl.value='EIGHTH SCHEDULE Table 1';
                itemEl.value='81';
            }
        }

        // Product dropdown (legacy style) handlers restored & integrated
        function openProductMenu(){ 
            console.log('Opening product menu'); 
            const menu=document.getElementById('product-menu'); 
            if(!menu) { 
                console.error('Product menu element not found'); 
                return; 
            } 
            menu.classList.remove('hidden'); 
            productMenuOpen=true; 
            if(productList.length===0){ 
                console.log('No products loaded, fetching now'); 
                fetchProducts(); 
            } else { 
                console.log('Rendering product menu with', productList.length, 'items'); 
                renderProductMenu(document.getElementById('product-filter')?.value||''); 
            } 
        }
        
        function closeProductMenu(){ 
            const menu=document.getElementById('product-menu'); 
            if(!menu) return; 
            menu.classList.add('hidden'); 
            productMenuOpen=false; 
        }
        
        function toggleProductMenu(){ 
            console.log('Toggling product menu, current state:', productMenuOpen ? 'open' : 'closed'); 
            if(productMenuOpen) closeProductMenu(); 
            else openProductMenu(); 
        }
        function selectProductRow(p){ if(!p) return; document.getElementById('product-selected-label').textContent=p.description||'-- Select Product --'; // populate main form
            document.getElementById('product-description').value=p.description||'';
            document.getElementById('product-hs-code').value=p.hs_code||'';
            if(p.rate!=null){ document.getElementById('product-rate').value=p.rate; }
            if(p.uom){ document.getElementById('product-uom').value=p.uom; }
            if(p.default_tax_rate!=null){ const taxSelect=document.getElementById('product-tax-rate'); const target=`${p.default_tax_rate}%`; for(let i=0;i<taxSelect.options.length;i++){ if(taxSelect.options[i].textContent.trim()===target){ taxSelect.selectedIndex=i; break; } } }
            document.getElementById('product-sale-type').value=p.sale_type||document.getElementById('product-sale-type').value;
                    if(isH075895User()){
                        const productCodeInput=document.getElementById('product-code');
                        if(productCodeInput){
                            productCodeInput.value=p.product_code||'';
                        }
                    }
            setSRODefaults(currentUsername);
            // If quantity already entered, recalc value & tax
            if(document.getElementById('product-quantity').value){ calculateValueAndTax(); }
            showNotification('success','Product Selected','Product fields populated'); }
        async function deleteProductInline(p){ if(!p||!p.id) return; if(!confirm('Delete this product?')) return; try{ const res=await fetch(apiUrl(`/api/products/${p.id}`),{method:'DELETE'}); const data=await res.json(); if(!res.ok) throw new Error(data.error||'Failed'); showNotification('success','Deleted','Product removed'); await fetchProducts(); openProductMenu(); }catch(e){ showNotification('error','Error',e.message);} }

        // Fetch user product settings (kept for SRO defaults + username)
        async function fetchProductSettings() {
            try {
                const resp = await fetch(apiUrl("/api/user-product-settings"));
                if (!resp.ok) throw new Error("Failed to fetch product settings");
                const settings = await resp.json();
                setCurrentUsernameValue(settings.username);
            } catch (e) {
                console.error("Error fetching product settings:", e);
            }
        }

        // Fetch products and render
        async function fetchProducts() {
            try {
                await ensureCurrentUsername();
                const baseUrl = apiUrl("/api/products");
                const url = isH075895User() ? `${baseUrl}&includeProductCode=true` : baseUrl;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Failed to fetch products");
                productList = await resp.json();
                renderProductMenu();
            } catch (e) {
                console.error("Error fetching products:", e);
                showNotification("error", "Error", "Could not load products");
            }
        }

        // Render filterable product list with delete buttons
        function renderProductMenu(filterText = "") {
            const listEl = document.getElementById("product-menu-list");
            if (!listEl) return;

            const norm = filterText.trim().toLowerCase();
            listEl.innerHTML = "";

            const filtered = norm
                ? productList.filter(p => p.description.toLowerCase().includes(norm))
                : productList;

            if (filtered.length === 0) {
                const emptyLi = document.createElement("li");
                emptyLi.className = "px-3 py-2 text-gray-500 text-xs";
                emptyLi.textContent = "No products found";
                listEl.appendChild(emptyLi);
                return;
            }

            // Add data-index attributes to help with keyboard navigation
            filtered.forEach((p, index) => {
                const li = document.createElement("li");
                li.className = "px-3 py-1.5 hover:bg-gray-100 cursor-pointer group";
                li.setAttribute("data-index", index);
                li.setAttribute("tabindex", "0"); // Make it focusable
                li.setAttribute("role", "option");

                // Improve click area to the entire row
                li.addEventListener("click", () => {
                    selectProductRow(p);
                    closeProductMenu();
                });

                // Add keyboard support
                li.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        selectProductRow(p);
                        closeProductMenu();
                    }
                });

                const contentDiv = document.createElement("div");
                contentDiv.className = "flex items-center justify-between w-full";

                const span = document.createElement("span");
                span.className = "truncate pr-2";
                span.textContent = p.description;

                const delBtn = document.createElement("button");
                delBtn.type = "button";
                delBtn.className = "opacity-60 group-hover:opacity-100 text-red-600 hover:text-red-700 px-1 py-0.5 rounded";
                delBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                delBtn.title = "Delete";
                delBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    deleteProductInline(p);
                });

                contentDiv.appendChild(span);
                contentDiv.appendChild(delBtn);
                li.appendChild(contentDiv);
                listEl.appendChild(li);
            });
        }

        async function saveProductsIfChecked() {
            const chk = document.getElementById("save-products-for-future");
            if (!chk || !chk.checked) return;

            if (!productList) productList = [];
            // Build a quick lookup of existing descriptions (case-insensitive trimmed)
            const existing = new Set(productList.map(p => p.description.trim().toLowerCase()));

            // Only save unique new descriptions
            const toSave = [];
            state.productItems.forEach(item => {
                const desc = (item.productDescription || "").trim();
                if (desc && !existing.has(desc.toLowerCase())) {
                    toSave.push(item);
                    existing.add(desc.toLowerCase());
                }
            });

            if (toSave.length === 0) return;

            try {
                // POST each product (serial or parallel). Parallel:
                await Promise.all(
                    toSave.map(item => {
                        const rawRate = (item.taxRate || "").toString();           // e.g. "18%", "18.00%", "0", ""
                        const rateNum = parseFloat(rawRate.replace("%", ""));       // NaN if empty
                        const cleanRate = isNaN(rateNum) ? 0 : rateNum;             // fallback to 0

                        return fetch(apiUrl("/api/products"), {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                description: item.productDescription,
                                hs_code: item.hsCode || "",
                                uom: item.uoM || "",
                                default_tax_rate: cleanRate,            // numeric
                                sale_type: item.saleType || "",
                                sro_schedule_no: item.sroScheduleNo || "",
                                sro_item_serial_no: item.sroItemSerialNo || ""
                            })
                        });
                    })
                );

                // Refresh catalog so they appear next time user opens dropdown
                await fetchProducts();
                showNotification("success", "Products Saved", "New products added to catalog");
            } catch (e) {
                console.error("Error saving products:", e);
                showNotification("error", "Save Failed", "Could not save some products");
            }
        }

        // Select a product (fills form fields)
        function selectProduct(productId) {
            const product = productList.find(p => p.id === parseInt(productId));
            if (!product) return;

            document.getElementById("product-description").value = product.description;
            document.getElementById("product-hs-code").value = product.hs_code || "";

            if (isH075895User()) {
                const productCodeInput = document.getElementById("product-code");
                if (productCodeInput) {
                    productCodeInput.value = product.product_code || "";
                }
            }

            // Set UOM if available
            const uomSelect = document.getElementById("product-uom");
            if (product.uom) {
                for (let i = 0; i < uomSelect.options.length; i++) {
                    if (uomSelect.options[i].value === product.uom) {
                        uomSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            // Set tax rate if available
            const taxRateSelect = document.getElementById("product-tax-rate");
            if (product.default_tax_rate) {
                const taxRateStr = `${product.default_tax_rate}%`;
                for (let i = 0; i < taxRateSelect.options.length; i++) {
                    if (taxRateSelect.options[i].label.trim() === taxRateStr) {
                        taxRateSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            // Set SRO fields based on username, not product values
            setSRODefaults(currentUsername);
        }

        // Add custom product
        async function addCustomProduct() {
            try {
                const description = document.getElementById("custom-product-input").value.trim();
                if (!description) {
                    showNotification("error", "Validation Error", "Please enter product name");
                    return;
                }

                const response = await fetch(apiUrl("/api/products"), {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        description: description,
                        default_tax_rate: 1 // Default tax rate
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Failed to save product");
                }

                const result = await response.json();
                showNotification("success", "Product Saved", "New product has been added");

                // Refresh products list
                await fetchProducts();

                // Set the new product as selected and hide custom field
                const selectElement = document.getElementById("product-select");
                if (!isH075895User()) {
                    selectElement.value = result.id;
                    document.getElementById("product-description").value = description;
                } else {
                    selectElement.value = "";
                    document.getElementById("product-description").value = "";
                    showNotification("info", "Product Ready", "Select the saved product from the list when needed.");
                }

                // Hide custom field
                document.getElementById("custom-product-field").classList.add("hidden");

            } catch (error) {
                console.error("Error saving custom product:", error);
                showNotification("error", "Error", error.message || "Failed to save product");
            }
        }

        // Add this function after the fetchFormOptions, fetchBusinessProfiles, etc. functions
        // but before the DOMContentLoaded event listener
        function initUserSpecificFields() {
            // Fetch user-specific settings
            fetch(apiUrl("/api/user-product-settings"))
                .then(response => response.json())
                .then(settings => {
                    setCurrentUsernameValue(settings.username);

                    // Show/hide delivery challan field based on username
                    if (settings.username === '8974121') {
                        const deliveryChallanContainer = document.getElementById("delivery-challan-container");
                        if (deliveryChallanContainer) {
                            deliveryChallanContainer.classList.remove("hidden");
                        }
                    }
                })
                .catch(error => {
                    console.error("Error fetching user settings:", error);
                });
        }

        // Initialize event handlers
        function initProductHandlers() {
            // Product select change
            document.getElementById("product-select").addEventListener("change", function () {
                if (this.value) {
                    selectProduct(this.value);
                }
            });

            // Custom product button
            document.getElementById("custom-product-btn").addEventListener("click", function () {
                document.getElementById("custom-product-field").classList.toggle("hidden");
                if (!document.getElementById("custom-product-field").classList.contains("hidden")) {
                    document.getElementById("custom-product-input").focus();
                }
            });

            // Save custom product
            document.getElementById("save-custom-product-btn").addEventListener("click", addCustomProduct);

            // Allow enter key to save custom product
            document.getElementById("custom-product-input").addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    addCustomProduct();
                }
            });
        }

        // --- Fuzzy search utility (simple subsequence & prefix boost) ---
function fuzzyMatch(term, text) {
  term = term.toLowerCase();
  text = text.toLowerCase();
  if (!term) return 1; // show all when empty
  if (text.startsWith(term)) return 2 + term.length / text.length; // strong prefix
  // subsequence
  let ti = 0;
  for (let i = 0; i < text.length && ti < term.length; i++) {
    if (text[i] === term[ti]) ti++;
  }
  return ti === term.length ? term.length / (text.length + 1) : 0;
}

let businessProfilesCache = [];
let editingBusinessProfileId = null;

function openBusinessProfileModal() {
  document.getElementById('business-profile-modal').classList.remove('hidden');
  loadBusinessProfiles();
  populateBPProvinces();
}
function closeBusinessProfileModal() {
  document.getElementById('business-profile-modal').classList.add('hidden');
  resetBPForm();
}
function populateBPProvinces(){
  const sel = document.getElementById('bp-province');
  if(!sel) return;
  // reuse existing seller province select options
  const sellerProvince = document.getElementById('seller-province');
  if (sellerProvince && sellerProvince.options.length > 1 && sel.options.length <= 1){
    for (let i=1;i<sellerProvince.options.length;i++){ sel.appendChild(sellerProvince.options[i].cloneNode(true)); }
  }
}
async function loadBusinessProfiles(){
  try {
    const res = await fetch(apiUrl('/api/business-profiles'));
    if(!res.ok) throw new Error('Failed to load');
    businessProfilesCache = await res.json();
    renderBusinessProfiles();
  } catch(e){
    showNotification('error','Error',e.message);
  }
}
function renderBusinessProfiles(){
  const list = document.getElementById('business-profile-list');
  const term = document.getElementById('business-profile-search').value.trim();
  list.innerHTML='';
  const scored = businessProfilesCache.map(p=>({p,score:fuzzyMatch(term,p.business_name)})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score || a.p.business_name.localeCompare(b.p.business_name));
  if(scored.length===0){
    list.innerHTML = '<div class="text-xs text-gray-500 px-2">No profiles found</div>'; return;
  }
  scored.forEach(({p})=>{
    const row = document.createElement('div');
    row.className='flex items-start justify-between bg-white rounded border border-gray-200 px-3 py-2 hover:shadow-sm transition';
    row.innerHTML = `
      <div class="text-sm"> <div class="font-medium text-gray-800 flex items-center space-x-2">
          <span>${p.business_name}</span>
          ${p.is_default ? '<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">Default</span>' : ''}
        </div>
        <div class="text-xs text-gray-500">${p.ntn_cnic}  ${p.province}</div>
        <div class="text-xs text-gray-400 truncate max-w-[260px]">${p.address || ''}</div>
      </div>
      <div class="flex items-center space-x-2">
        <button class="text-primary-600 hover:text-primary-800 text-xs font-medium" data-action="set" data-id="${p.id}" title="Set Default"><i class="fas fa-star"></i></button>
        <button class="text-blue-600 hover:text-blue-800 text-xs font-medium" data-action="edit" data-id="${p.id}" title="Edit"><i class="fas fa-edit"></i></button>
        <button class="text-red-600 hover:text-red-800 text-xs font-medium" data-action="del" data-id="${p.id}" title="Delete"><i class="fas fa-times"></i></button>
        <button class="text-accent-600 hover:text-accent-700 text-xs font-medium" data-action="apply" data-id="${p.id}" title="Use This"><i class="fas fa-check"></i></button>
      </div>`;
    list.appendChild(row);
  });
  list.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click',handleBPAction);
  });
}
function resetBPForm(){
  editingBusinessProfileId=null;
  document.getElementById('business-profile-form').classList.add('hidden');
  ['bp-name','bp-ntn','bp-strn','bp-province','bp-address'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  document.getElementById('bp-default').checked=false;
}
function showBPForm(edit=false){
  document.getElementById('business-profile-form').classList.remove('hidden');
  document.getElementById('business-profile-form-title').textContent = edit? 'Edit Profile':'Create Profile';
}
function handleBPAction(e){
  const id = e.currentTarget.getAttribute('data-id');
  const action = e.currentTarget.getAttribute('data-action');
  const profile = businessProfilesCache.find(p=>p.id==id);
  if(action==='del') return deleteBusinessProfile(id);
  if(action==='set') return setDefaultBusinessProfile(id);
  if(action==='apply' ){ applyBusinessProfile(profile); closeBusinessProfileModal(); return; }
  if(action==='edit' ){ editingBusinessProfileId=id; showBPForm(true); fillBPForm(profile); }
}
function fillBPForm(p){
  if(!p) return; showBPForm(true);
  document.getElementById('bp-name').value=p.business_name||'';
    document.getElementById('bp-ntn').value=normalizeTaxIdValue(p.ntn_cnic||'');
  document.getElementById('bp-strn').value=p.strn||'';
  document.getElementById('bp-province').value=p.province||'';
  document.getElementById('bp-address').value=p.address||'';
  document.getElementById('bp-default').checked=!!p.is_default;
}
async function deleteBusinessProfile(id){
  if(!confirm('Delete this business profile?')) return;
  try { const res = await fetch(apiUrl(`/api/business-profiles/${id}`),{method:'DELETE'}); const data=await res.json(); if(!res.ok) throw new Error(data.error||'Failed'); showNotification('success','Deleted','Profile removed'); await loadBusinessProfiles(); }
  catch(err){ showNotification('error','Error',err.message);} }
async function setDefaultBusinessProfile(id){
  try { const res = await fetch(apiUrl(`/api/business-profiles/${id}/default`),{method:'POST'}); const data=await res.json(); if(!res.ok) throw new Error(data.error||'Failed'); showNotification('success','Default Set','Profile marked default'); await loadBusinessProfiles(); }
  catch(err){ showNotification('error','Error',err.message);} }
function applyBusinessProfile(p){ if(!p) return; populateSellerForm({id:p.id,business_name:p.business_name,ntn_cnic:p.ntn_cnic,strn:p.strn,province:p.province,address:p.address,is_default:p.is_default}); }
async function saveBusinessProfileFromModal(){
    const bpNtnInput=document.getElementById('bp-ntn');
    const payload={ business_name:document.getElementById('bp-name').value.trim(), ntn_cnic:bpNtnInput.value.trim(), strn:document.getElementById('bp-strn').value.trim(), province:document.getElementById('bp-province').value, address:document.getElementById('bp-address').value.trim(), is_default:document.getElementById('bp-default').checked };
    if(!payload.business_name||!payload.ntn_cnic||!payload.province||!payload.address){ showNotification('error','Validation','All required fields must be filled'); return; }
    const normalizedBpTax=enforceTaxIdOnInput(bpNtnInput,'Business NTN/CNIC');
    if(!normalizedBpTax){ return; }
    payload.ntn_cnic=normalizedBpTax;
  try {
    let res, data;
    if(editingBusinessProfileId){
      res = await fetch(apiUrl(`/api/business-profiles/${editingBusinessProfileId}`),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      data = await res.json();
      if(!res.ok) throw new Error(data.error||'Update failed');
      showNotification('success','Updated','Profile updated');
    } else {
      res = await fetch(apiUrl('/api/business-profiles'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      data = await res.json();
      if(!res.ok) throw new Error(data.error||'Create failed');
      showNotification('success','Created','Profile created');
    }
    await loadBusinessProfiles();
    // auto apply latest (find by name + ntn)
    const applied = businessProfilesCache.find(p=>p.business_name===payload.business_name && p.ntn_cnic===payload.ntn_cnic) || businessProfilesCache[businessProfilesCache.length-1];
    if(applied) applyBusinessProfile(applied);
    resetBPForm();
    closeBusinessProfileModal();
  } catch(err){ showNotification('error','Error',err.message); }
}
// Event wiring (defer until DOM ready)
document.addEventListener('DOMContentLoaded',()=>{
  // Check again for draft loading (for reliability)
  const draftIdFromSecondHandler = getUrlParameter('load_draft');
  if (draftIdFromSecondHandler) {
    setTimeout(() => {
      try {
        loadDraftInvoice(draftIdFromSecondHandler);
      } catch (e) {
        console.error('Error loading draft from second handler:', e);
      }
    }, 800); // Wait a bit longer than the first handler
  }
  // Initialize form
  // Define setupForm function if not already defined
  function setupForm() {
    console.log('Setting up form components');
    // Ensure product dropdown functionality is ready
    const productSelectBtn = document.getElementById('product-select-btn');
    if (productSelectBtn) {
      console.log('Found product select button, setting up event listener');
      // Remove any existing listeners to prevent duplicates
      productSelectBtn.removeEventListener('click', toggleProductMenuHandler);
      // Add the event listener again
      productSelectBtn.addEventListener('click', toggleProductMenuHandler);
    } else {
      console.error('Product select button not found during setup');
    }
  }
  
  // Define handler function to avoid anonymous functions
  function toggleProductMenuHandler(e) {
    e.preventDefault();
    console.log('Product select button clicked');
    toggleProductMenu();
  }
  
  setupForm();
  
  const sellerSection = document.getElementById('step-1');
  if(sellerSection){
    // Add manage button at bottom of seller section if not exists
    if(!document.getElementById('open-manage-bp')){
      const manageBtn = document.createElement('button');
      manageBtn.id='open-manage-bp';
      manageBtn.type='button';
      manageBtn.className='mt-4 bg-secondary-600 hover:bg-secondary-700 text-white px-4 py-2 rounded-md text-sm';
      manageBtn.innerHTML='<i class="fas fa-building mr-1"></i>Manage Business Profiles';
      sellerSection.querySelector('#seller-form').appendChild(manageBtn);
      manageBtn.addEventListener('click',openBusinessProfileModal);
    }
  }
  document.getElementById('close-business-profile-modal')?.addEventListener('click',closeBusinessProfileModal);
  document.getElementById('business-profile-search')?.addEventListener('input',()=>renderBusinessProfiles());
  document.getElementById('new-business-profile-btn')?.addEventListener('click',()=>{editingBusinessProfileId=null;resetBPForm();showBPForm(false);});
  document.getElementById('cancel-bp-form')?.addEventListener('click',resetBPForm);
  document.getElementById('save-bp-form')?.addEventListener('click',saveBusinessProfileFromModal);
  document.getElementById('close-buyer-modal')?.addEventListener('click',closeBuyerModal);
  document.getElementById('buyer-search')?.addEventListener('input',renderBuyerList);
  document.getElementById('new-buyer-btn')?.addEventListener('click',()=>{ editingBuyerId=null; resetBuyerForm(); showBuyerForm(false); });
  document.getElementById('cancel-buyer-form')?.addEventListener('click',resetBuyerForm);
  document.getElementById('save-buyer-form')?.addEventListener('click',saveBuyerFromModal);
  document.getElementById('close-product-modal')?.addEventListener('click',closeProductModal);
  document.getElementById('product-search-modal')?.addEventListener('input',()=>{ renderProductListModal(window._allProductsModal||[]); });
  document.getElementById('refresh-products-btn')?.addEventListener('click',loadProductsModal);
  document.getElementById('cancel-product-form')?.addEventListener('click',resetProductModalForm);
  document.getElementById('save-product-form')?.addEventListener('click',saveProductFromModal);
    // Wire Step 4 plus/reset button to open product modal instead of just clearing fields
    document.getElementById('reset-product-btn')?.addEventListener('click',function(e){ e.preventDefault(); openProductModal(); });
    // Product dropdown events - ensure we grab the button directly
    const productSelectBtn = document.getElementById('product-select-btn');
    if(productSelectBtn) {
        console.log('Attaching product select button click handler from DOM ready event');
        productSelectBtn.addEventListener('click', toggleProductMenuHandler);
    } else {
        console.error('Product select button not found in DOM ready event');
    }
    document.getElementById('close-product-menu')?.addEventListener('click',function(e){ e.preventDefault(); closeProductMenu(); });
    document.getElementById('product-filter')?.addEventListener('input',function(){ renderProductMenu(this.value); });
    // Close menu when clicking outside
    document.addEventListener('click',function(ev){ const menu=document.getElementById('product-menu'); const btn=document.getElementById('product-select-btn'); if(!menu||menu.classList.contains('hidden')) return; if(!menu.contains(ev.target) && ev.target!==btn){ closeProductMenu(); } });
    // Initialize products
    fetchProducts();
});
    </script>
    <!-- Save Draft Modal -->
    <div id="save-draft-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Save Draft Invoice</h3>
                    <button id="close-save-draft-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label for="draft-invoice-title" class="block text-sm font-medium text-gray-700 mb-1">Draft
                        Title</label>
                    <input type="text" id="draft-invoice-title"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"
                        placeholder="Enter a title for your draft invoice">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-save-draft"
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button id="confirm-save-draft"
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700">
                        Save Draft
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Buyer Management Modal -->
    <div id="buyer-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
      <div class="modal-overlay absolute inset-0"></div>
      <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Manage Buyers</h3>
            <button id="close-buyer-modal" class="text-gray-400 hover:text-gray-500"><i class="fas fa-times"></i></button>
          </div>
          <div class="mb-4 flex items-center space-x-2">
            <input type="text" id="buyer-search" placeholder="Search buyers..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
            <button id="new-buyer-btn" class="px-3 py-2 bg-secondary-600 hover:bg-secondary-700 text-white rounded-md text-sm"><i class="fas fa-plus mr-1"></i>New</button>
          </div>
          <div id="buyer-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto border border-gray-200 rounded-md p-2 bg-gray-50"></div>
          <div id="buyer-form-modal" class="hidden border-t pt-4">
            <h4 class="font-medium text-gray-800 mb-2" id="buyer-form-title">Create Buyer</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Business Name*</label><input id="by-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">NTN/CNIC*</label><input id="by-ntn" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">STRN</label><input id="by-strn" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Province*</label><select id="by-province" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select Province --</option></select></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Registration Type*</label><select id="by-reg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select Type --</option></select></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Buyer Code</label><input id="by-code" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"/></div>
              <div class="md:col-span-2"><label class="block text-xs font-semibold text-gray-600 mb-1">Address*</label><textarea id="by-address" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"></textarea></div>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
              <button id="cancel-buyer-form" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 text-sm">Cancel</button>
              <button id="save-buyer-form" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md text-sm font-medium"><i class="fas fa-save mr-1"></i>Save Buyer</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Creation Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
      <div class="modal-overlay absolute inset-0"></div>
      <div class="bg-white rounded-lg shadow-xl z-50 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Create Product</h3>
            <button id="close-product-modal" class="text-gray-400 hover:text-gray-500"><i class="fas fa-times"></i></button>
          </div>
          <div class="mb-4 flex items-center space-x-2">
            <input type="text" id="product-search-modal" placeholder="Search existing..." class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" />
            <button id="refresh-products-btn" class="px-3 py-2 bg-secondary-600 hover:bg-secondary-700 text-white rounded-md text-sm"><i class="fas fa-rotate mr-1"></i>Refresh</button>
          </div>
          <div id="product-list-modal" class="space-y-2 mb-6 max-h-56 overflow-y-auto border border-gray-200 rounded-md p-2 bg-gray-50"></div>
          <div id="product-form-modal" class="border-t pt-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Description*</label><input id="pm-desc" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">HS Code</label><input id="pm-hs" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Rate (Unit)</label><input id="pm-rate" type="number" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">UoM*</label><select id="pm-uom" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select UoM --</option></select></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Default Tax Rate*</label><select id="pm-tax" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm"><option value="">-- Select Tax --</option></select></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">Sale Type</label><input id="pm-sale-type" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" value="Goods at Reduced Rate" /></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">SRO Schedule No</label><input id="pm-sro-schedule" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
              <div><label class="block text-xs font-semibold text-gray-600 mb-1">SRO Item Serial No</label><input id="pm-sro-item" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm" /></div>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
              <button id="cancel-product-form" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 text-sm">Cancel</button>
              <button id="save-product-form" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md text-sm font-medium"><i class="fas fa-save mr-1"></i>Save Product</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
let buyersCache=[]; let editingBuyerId=null;
function openBuyerModal(){ document.getElementById('buyer-modal').classList.remove('hidden'); loadBuyersModal(); populateBuyerModalSelects(); }
function closeBuyerModal(){ document.getElementById('buyer-modal').classList.add('hidden'); resetBuyerForm(); }
function populateBuyerModalSelects(){ const provSel=document.getElementById('by-province'); const regSel=document.getElementById('by-reg'); if(provSel && provSel.options.length<=1){ const src=document.getElementById('buyer-province'); for(let i=1;i<src.options.length;i++){ provSel.appendChild(src.options[i].cloneNode(true)); } } if(regSel && regSel.options.length<=1){ const regSrc=document.getElementById('buyer-registration-type'); for(let i=1;i<regSrc.options.length;i++){ regSel.appendChild(regSrc.options[i].cloneNode(true)); } } }
async function loadBuyersModal(){ try{ const res=await fetch(apiUrl('/api/buyers')); if(!res.ok) throw new Error('Failed to load buyers'); buyersCache=await res.json(); renderBuyerList(); }catch(e){ showNotification('error','Error',e.message);} }
function renderBuyerList(){
    const list=document.getElementById('buyer-list');
    const term=document.getElementById('buyer-search').value.trim();
    list.innerHTML='';
    const scored = buyersCache
        .map(b=>({b,score:fuzzyMatch(term,b.business_name)}))
        .filter(x=>x.score>0)
        // FIX: reference b.b not b.p in comparator (previously caused undefined error)
        .sort((a,b)=> b.score - a.score || a.b.business_name.localeCompare(b.b.business_name));
    if(scored.length===0){
        list.innerHTML = '<div class="text-xs text-gray-500 px-2">No buyers found</div>';
        return;
    }
    scored.forEach(({b})=>{
        const row=document.createElement('div');
        row.className='flex items-start justify-between bg-white rounded border border-gray-200 px-3 py-2 hover:shadow-sm transition';
        row.innerHTML=`<div class='text-sm'><div class='font-medium text-gray-800 truncate max-w-[240px]'>${b.business_name}</div><div class='text-xs text-gray-500'>${b.ntn_cnic}  ${b.province}</div><div class='text-xs text-gray-400 truncate max-w-[260px]'>${b.address||''}</div></div><div class='flex items-center space-x-2'><button class='text-blue-600 hover:text-blue-800 text-xs font-medium' data-action='edit' data-id='${b.id}'><i class='fas fa-edit'></i></button><button class='text-red-600 hover:text-red-800 text-xs font-medium' data-action='del' data-id='${b.id}'><i class='fas fa-times'></i></button><button class='text-accent-600 hover:text-accent-700 text-xs font-medium' data-action='apply' data-id='${b.id}'><i class='fas fa-check'></i></button></div>`;
        list.appendChild(row);
    });
    list.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click',handleBuyerAction));
}
function resetBuyerForm(){ editingBuyerId=null; document.getElementById('buyer-form-modal').classList.add('hidden'); ['by-name','by-ntn','by-strn','by-province','by-reg','by-code','by-address'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';}); }
function showBuyerForm(edit=false){ document.getElementById('buyer-form-modal').classList.remove('hidden'); document.getElementById('buyer-form-title').textContent=edit?'Edit Buyer':'Create Buyer'; }
function handleBuyerAction(e){ const id=e.currentTarget.getAttribute('data-id'); const action=e.currentTarget.getAttribute('data-action'); const buyer=buyersCache.find(b=>b.id==id); if(action==='del') return deleteBuyer(id); if(action==='apply'){ applyBuyer(buyer); closeBuyerModal(); return;} if(action==='edit' ){ editingBuyerId=id; showBuyerForm(true); fillBuyerForm(buyer); }
}
function fillBuyerForm(b){ if(!b) return; ['by-name','by-ntn','by-strn','by-province','by-reg','by-code','by-address'].forEach(()=>{}); document.getElementById('by-name').value=b.business_name||''; document.getElementById('by-ntn').value=normalizeTaxIdValue(b.ntn_cnic||''); document.getElementById('by-strn').value=b.strn||''; document.getElementById('by-province').value=b.province||''; document.getElementById('by-reg').value=b.registration_type||''; document.getElementById('by-code').value=b.buyer_code||''; document.getElementById('by-address').value=b.address||''; }
async function deleteBuyer(id){ if(!confirm('Delete this buyer?')) return; try{ const res=await fetch(apiUrl(`/api/buyers/${id}`),{method:'DELETE'}); const data=await res.json(); if(!res.ok) throw new Error(data.error||'Failed'); showNotification('success','Deleted','Buyer removed'); await loadBuyersModal(); }
catch(err){ showNotification('error','Error',err.message);} }
function applyBuyer(b){ if(!b) return; populateBuyerForm({id:b.id,business_name:b.business_name,address:b.address,province:b.province,ntn_cnic:b.ntn_cnic,strn:b.strn,registration_type:b.registration_type,buyer_code:b.buyer_code}); }
async function saveBuyerFromModal(){ const buyerNtnInput=document.getElementById('by-ntn'); const payload={ business_name:document.getElementById('by-name').value.trim(), ntn_cnic:buyerNtnInput.value.trim(), strn:document.getElementById('by-strn').value.trim(), province:document.getElementById('by-province').value, registration_type:document.getElementById('by-reg').value, buyer_code:document.getElementById('by-code').value.trim(), address:document.getElementById('by-address').value.trim() }; if(!payload.business_name||!payload.ntn_cnic||!payload.province||!payload.registration_type||!payload.address){ showNotification('error','Validation','Required fields missing'); return;} const normalizedBuyerTax=enforceTaxIdOnInput(buyerNtnInput,'Buyer NTN/CNIC'); if(!normalizedBuyerTax){ return;} payload.ntn_cnic=normalizedBuyerTax; const creatingNew=!editingBuyerId; try{ let res,data; if(editingBuyerId){ res=await fetch(apiUrl(`/api/buyers/${editingBuyerId}`),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); data=await res.json(); if(!res.ok) throw new Error(data.error||'Update failed'); showNotification('success','Updated','Buyer updated'); } else { res=await fetch(apiUrl('/api/buyers'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); data=await res.json(); if(!res.ok) throw new Error(data.error||'Create failed'); showNotification('success','Created','Buyer created'); }
    await loadBuyersModal();
    if(creatingNew && isH075895User()){
        if(typeof fetchBuyers==='function'){
            await fetchBuyers();
        }
        resetBuyerForm();
        showNotification('info','Buyer Ready','Select the new buyer from the list to apply it.');
        return;
    }
    const applied=buyersCache.find(b=>b.business_name===payload.business_name && b.ntn_cnic===payload.ntn_cnic) || buyersCache[buyersCache.length-1]; if(applied) applyBuyer(applied); closeBuyerModal(); resetBuyerForm(); }catch(err){ showNotification('error','Error',err.message);} }

// ---------------- Product Modal Logic (mirrors buyer modal) ----------------
let productsCache = []; let editingProductId = null;
function openProductModal(){ document.getElementById('product-modal').classList.remove('hidden'); loadProductsModal(); populateProductModalSelects(); }
function closeProductModal(){ document.getElementById('product-modal').classList.add('hidden'); resetProductModalForm(); }
function populateProductModalSelects(){ const uomSel=document.getElementById('pm-uom'); const taxSel=document.getElementById('pm-tax'); if(uomSel && uomSel.options.length<=1){ const src=document.getElementById('product-uom'); for(let i=1;i<src.options.length;i++){ uomSel.appendChild(src.options[i].cloneNode(true)); } } if(taxSel && taxSel.options.length<=1){ const taxSrc=document.getElementById('product-tax-rate'); for(let i=1;i<taxSrc.options.length;i++){ taxSel.appendChild(taxSrc.options[i].cloneNode(true)); } } }
async function loadProductsModal(){
    try{
        await ensureCurrentUsername();
        const baseUrl=apiUrl('/api/products');
        const url=isH075895User()? `${baseUrl}&includeProductCode=true` : baseUrl;
        const res=await fetch(url);
        if(!res.ok) throw new Error('Failed to load products');
        productsCache=await res.json();
        window._allProductsModal = productsCache.slice();
        renderProductListModal(productsCache);
    }catch(e){
        showNotification('error','Error',e.message);
    }
}
function renderProductListModal(arr){ const list=document.getElementById('product-list-modal'); if(!list) return; const term=(document.getElementById('product-search-modal').value||'').trim(); list.innerHTML=''; const scored=arr.map(p=>({p,score:fuzzyMatch(term,p.description||'')})).filter(x=>x.score>0).sort((a,b)=> b.score-a.score || (a.p.description||'').localeCompare(b.p.description||'')); if(scored.length===0){ list.innerHTML='<div class="text-xs text-gray-500 px-2">No products found</div>'; return;} scored.forEach(({p})=>{ const row=document.createElement('div'); row.className='flex items-start justify-between bg-white rounded border border-gray-200 px-3 py-2 hover:shadow-sm transition'; row.innerHTML=`<div class='text-sm'><div class='font-medium text-gray-800 truncate max-w-[240px]'>${p.description||''}</div><div class='text-xs text-gray-500'>${p.hs_code||''} ${(p.uom? ' '+p.uom:'')}</div><div class='text-xs text-gray-400 truncate max-w-[260px]'>${p.sale_type||''}</div></div><div class='flex items-center space-x-2'><button class='text-blue-600 hover:text-blue-800 text-xs font-medium' data-action='edit' data-id='${p.id}'><i class='fas fa-edit'></i></button><button class='text-red-600 hover:text-red-800 text-xs font-medium' data-action='del' data-id='${p.id}'><i class='fas fa-times'></i></button><button class='text-accent-600 hover:text-accent-700 text-xs font-medium' data-action='apply' data-id='${p.id}'><i class='fas fa-check'></i></button></div>`; list.appendChild(row);} ); list.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click',handleProductAction)); }
function resetProductModalForm(){ editingProductId=null; ['pm-desc','pm-code','pm-hs','pm-rate','pm-uom','pm-tax','pm-sale-type','pm-sro-schedule','pm-sro-item'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); document.getElementById('product-form-modal')?.classList.remove('hidden'); }
function showProductForm(edit=false){ document.getElementById('product-form-modal').classList.remove('hidden'); }
function handleProductAction(e){ const id=e.currentTarget.getAttribute('data-id'); const action=e.currentTarget.getAttribute('data-action'); const prod=productsCache.find(p=>p.id==id); if(action==='del') return deleteProductFromModal(id); if(action==='apply'){ applyProduct(prod); closeProductModal(); return;} if(action==='edit'){ editingProductId=id; fillProductForm(prod); showProductForm(true);} }
function fillProductForm(p){ if(!p) return; document.getElementById('pm-desc').value=p.description||''; const pmCodeInput=document.getElementById('pm-code'); if(pmCodeInput){ pmCodeInput.value=isH075895User()? (p.product_code||'') : ''; } document.getElementById('pm-hs').value=p.hs_code||''; document.getElementById('pm-rate').value=p.rate||''; document.getElementById('pm-uom').value=p.uom||''; document.getElementById('pm-tax').value=p.default_tax_rate||''; document.getElementById('pm-sale-type').value=p.sale_type||'Goods at Reduced Rate'; document.getElementById('pm-sro-schedule').value=p.sro_schedule_no||''; document.getElementById('pm-sro-item').value=p.sro_item_serial_no||''; }
function applyProduct(p){ if(!p) return; // fill main product entry form for new line item
    document.getElementById('product-description').value=p.description||'';
    document.getElementById('product-hs-code').value=p.hs_code||'';
    if(p.rate!=null){ document.getElementById('product-rate').value=p.rate; }
    if(p.uom){ document.getElementById('product-uom').value=p.uom; }
    // match tax rate label if exists
    if(p.default_tax_rate!=null){ const taxSelect=document.getElementById('product-tax-rate'); const target=`${p.default_tax_rate}%`; for(let i=0;i<taxSelect.options.length;i++){ if(taxSelect.options[i].textContent.trim()===target){ taxSelect.selectedIndex=i; break; } } }
    document.getElementById('product-sale-type').value=p.sale_type||document.getElementById('product-sale-type').value;
    // SRO defaults based on current user (not product) stay via setSRODefaults
    setSRODefaults(currentUsername);
    if(isH075895User()){
        const mainProductCodeInput=document.getElementById('product-code');
        if(mainProductCodeInput){
            const catalogCode=(p&&p.product_code)||'';
            let modalValue='';
            const modalProductCode=document.getElementById('pm-code');
            if(modalProductCode){
                modalValue=modalProductCode.value.trim();
            }
            mainProductCodeInput.value=catalogCode||modalValue||mainProductCodeInput.value;
        }
    }
    if(document.getElementById('product-quantity').value){ calculateValueAndTax(); }
    showNotification('success','Product Applied','Fields populated from product');
}
async function saveProductFromModal(){ const pmRate=parseFloat(document.getElementById('pm-rate').value)||0; const payload={ description:document.getElementById('pm-desc').value.trim(), hs_code:document.getElementById('pm-hs').value.trim(), rate:pmRate, uom:document.getElementById('pm-uom').value, default_tax_rate: parseFloat(document.getElementById('pm-tax').value)||0, sale_type:document.getElementById('pm-sale-type').value.trim(), sro_schedule_no:document.getElementById('pm-sro-schedule').value.trim(), sro_item_serial_no:document.getElementById('pm-sro-item').value.trim() }; const pmCodeInput=document.getElementById('pm-code'); if(isH075895User()){ payload.product_code=pmCodeInput? pmCodeInput.value.trim():''; payload.sale_type=''; payload.sro_schedule_no=''; payload.sro_item_serial_no=''; } if(!payload.description||!payload.uom){ showNotification('error','Validation','Description and UoM required'); return;} const creatingNew=!editingProductId; try { let res,data; if(editingProductId){ res=await fetch(apiUrl(`/api/products/${editingProductId}`),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); data=await res.json(); if(!res.ok) throw new Error(data.error||'Update failed'); showNotification('success','Updated','Product updated'); } else { res=await fetch(apiUrl('/api/products'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); data=await res.json(); if(!res.ok) throw new Error(data.error||'Create failed'); showNotification('success','Created','Product created'); }
        await loadProductsModal();
        if(creatingNew && isH075895User()){
            if(typeof fetchProducts==='function'){
                await fetchProducts();
            }
            resetProductModalForm();
            showNotification('info','Product Ready','Select the saved product from the list when needed.');
            return;
        }
        const applied=productsCache.find(p=>p.description===payload.description && p.hs_code===payload.hs_code) || productsCache[productsCache.length-1]; if(applied) applyProduct(applied); closeProductModal(); resetProductModalForm(); } catch(err){ showNotification('error','Error',err.message);} }
async function deleteProductFromModal(id){ if(!confirm('Delete this product?')) return; try{ const res=await fetch(apiUrl(`/api/products/${id}`),{method:'DELETE'}); const data=await res.json(); if(!res.ok) throw new Error(data.error||'Failed'); showNotification('success','Deleted','Product removed'); await loadProductsModal(); } catch(err){ showNotification('error','Error',err.message);} }
    </script>
  </body>

</html>